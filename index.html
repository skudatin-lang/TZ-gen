<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ТЗ-оферты для 3D моделей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f0f2f5;
            padding: 15px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #007cba;
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #007cba;
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background: #007cba;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            font-weight: 600;
            margin: 12px 0;
            transition: all 0.3s;
        }
        
        button:active {
            background: #005a87;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:active {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:active {
            background: #1e7e34;
        }
        
        .offer-view {
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007cba;
        }
        
        .project-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: 600;
            color: #007cba;
            margin-bottom: 8px;
            font-size: 18px;
            border-left: 4px solid #007cba;
            padding-left: 12px;
        }
        
        .criteria-list {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .criteria-list li {
            margin-bottom: 6px;
        }
        
        .stages-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .stages-table th,
        .stages-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .stages-table th {
            background-color: #007cba;
            color: white;
            font-weight: 600;
        }
        
        .bank-details {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            font-size: 16px;
        }
        
        .message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .optional-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .optional-fields {
            display: none;
            margin-top: 10px;
        }
        
        .contract-date {
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .contract-closing {
            margin-top: 30px;
            text-align: right;
        }
        
        .duration-select {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .duration-select select {
            flex: 1;
        }
        
        .cost-breakdown {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cost-total {
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #007cba;
        }
    </style>
</head>
<body>
    <div id="formView" class="container">
        <h1>Генератор ТЗ-оферты для 3D моделей</h1>
        
        <div class="form-group">
            <label>Название проекта:</label>
            <input type="text" id="project_name" value="3D модель персонажа">
        </div>
        
        <div class="form-group">
            <label>Общая стоимость моделирования (руб.):</label>
            <input type="number" id="total_cost" value="2500" onchange="calculateCostBreakdown()">
        </div>
        
        <div class="cost-breakdown">
            <h3>Разбивка стоимости моделирования:</h3>
            <div class="cost-item">
                <span>Этап 1 (20%):</span>
                <span id="stage1_cost">500 руб.</span>
            </div>
            <div class="cost-item">
                <span>Этап 2 (30%):</span>
                <span id="stage2_cost">750 руб.</span>
            </div>
            <div class="cost-item">
                <span>Этап 3 (50%):</span>
                <span id="stage3_cost">1250 руб.</span>
            </div>
            <div class="cost-total">
                <span>Итого:</span>
                <span id="total_cost_display">2500 руб.</span>
            </div>
        </div>
        
        <div class="form-group">
            <label>Формат файла:</label>
            <select id="file_format">
                <option value=".stl" selected>.stl</option>
                <option value=".obj">.obj</option>
                <option value=".fbx">.fbx</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Размер модели:</label>
            <input type="text" id="model_height" value="150 мм">
        </div>
        
        <div class="form-group">
            <label>Цель использования:</label>
            <textarea id="purpose">Для последующей 3D-печати и коллекционирования.</textarea>
        </div>
        
        <div class="form-group">
            <label>Исходные данные (референсы):</label>
            <textarea id="photos_description">Референсные материалы (фотографии, эскизы), предоставленные Заказчиком. Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.</textarea>
        </div>
        
        <div class="form-group">
            <label>Стоимость правок (руб./подход):</label>
            <input type="number" id="corrections_cost" value="500">
        </div>
        
        <div class="optional-section">
            <h3>Сроки выполнения этапов (в календарных днях)</h3>
            
            <div class="form-group">
                <label>Подготовка 3D-эскиза после оплаты этапов 1 и 2:</label>
                <div class="duration-select">
                    <select id="stage2_duration">
                        <option value="1">1 день</option>
                        <option value="2" selected>2 дня</option>
                        <option value="3">3 дня</option>
                        <option value="4">4 дня</option>
                        <option value="5">5 дней</option>
                        <option value="6">6 дней</option>
                        <option value="7">7 дней</option>
                        <option value="8">8 дней</option>
                        <option value="9">9 дней</option>
                        <option value="10">10 дней</option>
                        <option value="11">11 дней</option>
                        <option value="12">12 дней</option>
                        <option value="13">13 дней</option>
                        <option value="14">14 дней</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Подготовка модели после утверждения эскиза и оплаты этапа 3:</label>
                <div class="duration-select">
                    <select id="stage3_duration">
                        <option value="1">1 день</option>
                        <option value="2">2 дня</option>
                        <option value="3" selected>3 дня</option>
                        <option value="4">4 дня</option>
                        <option value="5">5 дней</option>
                        <option value="6">6 дней</option>
                        <option value="7">7 дней</option>
                        <option value="8">8 дней</option>
                        <option value="9">9 дней</option>
                        <option value="10">10 дней</option>
                        <option value="11">11 дней</option>
                        <option value="12">12 дней</option>
                        <option value="13">13 дней</option>
                        <option value="14">14 дней</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="optional-section">
            <h3>Дополнительные услуги</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_printing" onchange="togglePrintingFields()">
                <label for="include_printing">Включить услугу печати</label>
            </div>
            
            <div id="printing_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость печати (руб.):</label>
                    <input type="number" id="printing_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения печати после утверждения модели и оплаты:</label>
                    <div class="duration-select">
                        <select id="printing_duration">
                            <option value="1">1 день</option>
                            <option value="2">2 дня</option>
                            <option value="3" selected>3 дня</option>
                            <option value="4">4 дня</option>
                            <option value="5">5 дней</option>
                            <option value="6">6 дней</option>
                            <option value="7">7 дней</option>
                            <option value="8">8 дней</option>
                            <option value="9">9 дней</option>
                            <option value="10">10 дней</option>
                            <option value="11">11 дней</option>
                            <option value="12">12 дней</option>
                            <option value="13">13 дней</option>
                            <option value="14">14 дней</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_painting" onchange="togglePaintingFields()">
                <label for="include_painting">Включить услугу покраски</label>
            </div>
            
            <div id="painting_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость покраски (руб.):</label>
                    <input type="number" id="painting_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения покраски после утверждения модели и оплаты:</label>
                    <div class="duration-select">
                        <select id="painting_duration">
                            <option value="1">1 день</option>
                            <option value="2">2 дня</option>
                            <option value="3">3 дня</option>
                            <option value="4">4 дня</option>
                            <option value="5" selected>5 дней</option>
                            <option value="6">6 дней</option>
                            <option value="7">7 дней</option>
                            <option value="8">8 дней</option>
                            <option value="9">9 дней</option>
                            <option value="10">10 дней</option>
                            <option value="11">11 дней</option>
                            <option value="12">12 дней</option>
                            <option value="13">13 дней</option>
                            <option value="14">14 дней</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Реквизиты для оплаты:</label>
            <textarea id="bank_details">Т-банк Константин Сергеевич С. 89777145325</textarea>
        </div>
        
        <button onclick="generateOffer()">Сгенерировать ТЗ-оферту</button>
    </div>

    <div id="offerView" class="container offer-view">
        <div class="header">
            <h1>ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)</h1>
            <h2>к Договору на создание 3D-модели</h2>
        </div>

        <div class="project-info">
            <strong id="projectNumber"></strong><br>
            <span id="projectNameDisplay"></span>
        </div>

        <div class="section">
            <div class="section-title">1. Цель и назначение модели</div>
            <p id="purposeDisplay"></p>
        </div>

        <div class="section">
            <div class="section-title">2. Исходные данные</div>
            <ul class="criteria-list">
                <li>Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.</li>
                <li>Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">3. Технические требования к модели</div>
            <ul class="criteria-list">
                <li>Итоговый файл предоставляется в формате <span id="fileFormatDisplay"></span>, готовом к 3D-печати.</li>
                <li>Модель оптимизирована для процесса FDM/SLA печати (удаление невидимых полигонов, обеспечение целостности сетки).</li>
                <li>Важное условие: Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство, а не созданием его точной фотометрической копии. Восприятие объема, пропорций и деталей может отличаться от исходного плоского изображения в силу технических особенностей процесса.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">4. Визуальные критерии (Критерии оценки)</div>
            <p>Результат считается соответствующим ТЗ при совпадении по следующим объективным параметрам. Допускаются незначительные отклонения, обусловленные переводом из 2D в 3D и техническими требованиями печати.</p>
            <ul class="criteria-list">
                <li><strong>Силуэт:</strong> Считается соответствующим, если он узнаваем и сопоставим с исходным изображением, сохраняя ключевые пропорции. Отличия контура, вызванные интерпретацией перспективы и объема, допустимы.</li>
                <li><strong>Крупные детали:</strong> Расположение и общая форма основных элементов (одежда, снаряжение, черты лица, прическа) соответствуют референсу и в совокупности образуют узнаваемый образ.</li>
                <li><strong>Поза:</strong> Ракурс и положение тела/объекта соответствуют референсу.</li>
                <li><strong>Композиция:</strong> Расположение элементов модели в пространстве соответствует референсу.</li>
                <li><strong>Мелкая детализация</strong> (текстуры, складки, узоры) выполняется на усмотрение Исполнителя в рамках общего стиля и не является отдельным критерием приемки.</li>
            </ul>
            <p>Следующие отклонения считаются допустимыми по умолчанию:</p>
            <ul class="criteria-list">
                <li>Упрощение или укрепление элементов для обеспечения надежности 3D-печати.</li>
                <li>Интерпретация деталей, нечетко видимых или отсутствующих на исходном изображении.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">5. Порядок приемки работы (Процедура предоставления обратной связи)</div>
            <ul class="criteria-list">
                <li>Результаты каждого этапа работы направляются Заказчику для ознакомления.</li>
                <li>При наличии замечаний, Заказчик обязуется предоставить обратную связь в виде скриншотов с четкими графическими пометками (стрелки, кружки), поясняющими характер правки.</li>
                <li>Текстовые описания правок без визуальных пометок к рассмотрению не принимаются.</li>
                <li>Фактом утверждения этапов печати и покраски является отправка фото готового изделия Исполнителем.</li>
            </ul>
        </div>

        <div class="header">
            <h1>ДОГОВОР-ОФЕРТА</h1>
            <h2>на оказание услуг по созданию 3D-модели</h2>
        </div>

        <div class="contract-date">
            г. Москва «<span id="contractDay"></span>» <span id="contractMonth"></span> <span id="contractYear"></span> г.
        </div>

        <div class="section">
            <div class="section-title">1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ</div>
            <p>Исполнитель: Константин Сергеевич С., предлагает заключить настоящий Договор любому физическому или юридическому лицу (далее — Заказчик) на следующих условиях. Акцепт оферты (подтверждение заказа) осуществляется путем оплаты в соответствии с условиями, указанными ниже.</p>
            <p>Исполнитель обязуется создать 3D-модель в соответствии с Техническим заданием (ТЗ), а Заказчик — принять и оплатить работу.</p>
        </div>

        <div class="section">
            <div class="section-title">2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ</div>
            <p>Общая стоимость Заказа составляет: <strong><span id="totalCostDisplay"></span> рублей</strong>.</p>
            
            <table class="stages-table">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Наименование этапа</th>
                        <th>Срок исполнения*</th>
                        <th>Стоимость этапа</th>
                        <th>Условие подтверждения/оплаты</th>
                    </tr>
                </thead>
                <tbody id="stagesTableBody">
                </tbody>
            </table>
            
            <p><em>*Сроки могут быть скорректированы по согласованию Сторон.</em></p>
            
            <div id="additionalStagesTable"></div>
            
            <p><em>Все правки к этапам, ранее принятым Заказчиком, оплачиваются дополнительно: <span id="correctionsCostDisplay"></span> руб./подход</em></p>
        </div>

        <div class="section">
            <div class="section-title">3. ПОРЯДОК ОПЛАТЫ</div>
            <ol class="criteria-list">
                <li>Этап 1: 20% от стоимости моделирования - оплата в течение 2 рабочих дней с момента отправки предложения</li>
                <li>Этап 2: 30% от стоимости моделирования - оплачивается одновременно с Этапом 1, списывается при передаче материалов готового эскиза</li>
                <li>Этап 3: 50% от стоимости моделирования - оплачивается в течение 2 рабочих дней с момента утверждения эскиза, списывается после утверждения готовой модели</li>
                <li>Дополнительные услуги (печать, покраска): 100% стоимости услуги - оплачивается в течение 2 рабочих дней с момента утверждения предыдущего этапа, списывается моментально</li>
                <li>Реквизиты для оплаты:
                    <div class="bank-details" id="bankDetailsDisplay"></div>
                </li>
                <li>Подтверждением оплаты является чек.</li>
            </ol>
        </div>

        <div class="section">
            <div class="section-title">4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ</div>
            <p>Услуги 3D-печати и покраски являются отдельными, не зависящими от создания модели, и отражаются в ТЗ как самостоятельные этапы с отдельной 100% предоплатой. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от данных услуг после их оплаты невозможен, возврат средств не производится.</p>
            <div id="additionalServicesSection"></div>
        </div>

        <div class="section">
            <div class="section-title">5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ</div>
            <ol class="criteria-list">
                <li>Оплата Заказа означает полное и безоговорочное принятие Заказчиком всех условий настоящего Договора-оферты и прилагаемого ТЗ.</li>
                <li>Все правки к этапам, ранее принятым Заказчиком (в соответствии с п.2), оплачиваются дополнительно по отдельному соглашению.</li>
                <li>Все споры Стороны решают путем переговоров, а при недостижении согласия — в суде по месту нахождения Исполнителя.</li>
            </ol>
        </div>

        <div class="contract-closing">
            <p><strong>Исполнитель:</strong><br>
            Константин Сергеевич С.</p>
        </div>

        <button class="btn-success" onclick="window.print()">Распечатать ТЗ</button>
        <button onclick="shareAsText()">Поделиться как текст</button>
        
        <div class="message" id="message"></div>
    </div>

    <script>
        // Функции для показа/скрытия дополнительных полей
        function togglePrintingFields() {
            var printingFields = document.getElementById('printing_fields');
            printingFields.style.display = document.getElementById('include_printing').checked ? 'block' : 'none';
        }
        
        function togglePaintingFields() {
            var paintingFields = document.getElementById('painting_fields');
            paintingFields.style.display = document.getElementById('include_painting').checked ? 'block' : 'none';
        }

        // Функция для расчета разбивки стоимости
        function calculateCostBreakdown() {
            var totalCost = parseInt(document.getElementById('total_cost').value) || 0;
            var stage1Cost = Math.round(totalCost * 0.2);
            var stage2Cost = Math.round(totalCost * 0.3);
            var stage3Cost = totalCost - stage1Cost - stage2Cost;
            
            document.getElementById('stage1_cost').textContent = stage1Cost + ' руб.';
            document.getElementById('stage2_cost').textContent = stage2Cost + ' руб.';
            document.getElementById('stage3_cost').textContent = stage3Cost + ' руб.';
            document.getElementById('total_cost_display').textContent = totalCost + ' руб.';
        }

        // Функция для получения названия месяца
        function getMonthName(month) {
            var months = [
                'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
            ];
            return months[month];
        }

        // Функция для склонения слова "день"
        function getDayWord(days) {
            if (days === 1) return 'день';
            if (days >= 2 && days <= 4) return 'дня';
            return 'дней';
        }

        // Основная функция генерации оферты
        function generateOffer() {
            try {
                // Собираем данные
                var data = {
                    project_name: document.getElementById('project_name').value,
                    total_cost: parseInt(document.getElementById('total_cost').value) || 2500,
                    file_format: document.getElementById('file_format').value,
                    model_height: document.getElementById('model_height').value,
                    purpose: document.getElementById('purpose').value,
                    photos_description: document.getElementById('photos_description').value,
                    corrections_cost: parseInt(document.getElementById('corrections_cost').value) || 500,
                    bank_details: document.getElementById('bank_details').value,
                    // Длительности этапов
                    stage2_duration: parseInt(document.getElementById('stage2_duration').value) || 2,
                    stage3_duration: parseInt(document.getElementById('stage3_duration').value) || 3,
                    // Дополнительные услуги
                    include_printing: document.getElementById('include_printing').checked,
                    printing_cost: parseInt(document.getElementById('printing_cost').value) || 0,
                    printing_duration: parseInt(document.getElementById('printing_duration').value) || 3,
                    include_painting: document.getElementById('include_painting').checked,
                    painting_cost: parseInt(document.getElementById('painting_cost').value) || 0,
                    painting_duration: parseInt(document.getElementById('painting_duration').value) || 5,
                    // Метаданные
                    created_at: new Date().toISOString(),
                    version: '3.0'
                };

                // Рассчитываем стоимость этапов
                var stage1Cost = Math.round(data.total_cost * 0.2);
                var stage2Cost = Math.round(data.total_cost * 0.3);
                var stage3Cost = data.total_cost - stage1Cost - stage2Cost;

                // Генерируем номер
                data.project_number = 'ТЗ-' + new Date().getTime();
                data.created_at_display = new Date().toLocaleString('ru-RU');

                // Рассчитываем основные этапы
                var stages = [
                    {
                        number: '1',
                        name: 'Оплата начала работ',
                        duration: 'В течение 2 рабочих дней с момента отправки предложения',
                        cost: stage1Cost + ' руб. (20%)',
                        condition: 'Оплата является подтверждением заказа и принятием условий оферты.'
                    },
                    {
                        number: '2',
                        name: 'Оплата за эскиз',
                        duration: 'Одновременно с Этапом 1',
                        cost: stage2Cost + ' руб. (30%)',
                        condition: 'Списывается при передаче материалов готового эскиза (фото, ссылка). Этап считается принятым с возможностью внесения правок по усмотрению Заказчика в соответствии с регламентом.'
                    },
                    {
                        number: '3',
                        name: 'Подготовка 3D-эскиза',
                        duration: 'В течение ' + data.stage2_duration + ' ' + getDayWord(data.stage2_duration) + ' после оплаты Этапов 1 и 2',
                        cost: 'Включено в стоимость моделирования',
                        condition: 'Заказчик обязан в течение 48 часов с момента получения эскиза предоставить обратную связь или утвердить эскиз.'
                    },
                    {
                        number: '4',
                        name: 'Оплата за финальную модель',
                        duration: 'В течение 2 рабочих дней с момента утверждения эскиза',
                        cost: stage3Cost + ' руб. (50%)',
                        condition: 'Списывается после утверждения Заказчиком готовой модели.'
                    },
                    {
                        number: '5',
                        name: 'Подготовка финальной модели',
                        duration: 'В течение ' + data.stage3_duration + ' ' + getDayWord(data.stage3_duration) + ' после оплаты Этапа 4',
                        cost: 'Включено в стоимость моделирования',
                        condition: 'Заказчик обязан в течение 48 часов с момента получения финальной модели предоставить обратную связь или утвердить модель.'
                    }
                ];

                // Дополнительные этапы
                var additionalStages = [];
                var additionalServicesHTML = '';
                var stageCounter = 6;
                
                if (data.include_printing) {
                    additionalStages.push({
                        number: stageCounter.toString(),
                        name: 'Оплата за печать',
                        duration: 'В течение 2 рабочих дней с момента утверждения модели',
                        cost: data.printing_cost + ' руб. (100%)',
                        condition: 'Списывается моментально в счет материалов и оплаты работы подрядчика.'
                    });
                    
                    additionalStages.push({
                        number: (stageCounter + 1).toString(),
                        name: 'Печать',
                        duration: 'В течение ' + data.printing_duration + ' ' + getDayWord(data.printing_duration) + ' после оплаты',
                        cost: 'Включено в стоимость печати',
                        condition: 'Фактом утверждения этапа является отправка фото готового изделия Исполнителем. В связи с заказом физических материалов, отказ от услуги после оплаты невозможен, возврат средств не производится.'
                    });
                    
                    stageCounter += 2;
                    additionalServicesHTML += '<p><strong>Услуга печати:</strong> ' + data.printing_cost + ' руб. (100% предоплата)</p>';
                }
                
                if (data.include_painting) {
                    additionalStages.push({
                        number: stageCounter.toString(),
                        name: 'Оплата за покраску',
                        duration: 'В течение 2 рабочих дней с момента утверждения модели',
                        cost: data.painting_cost + ' руб. (100%)',
                        condition: 'Списывается моментально в счет материалов и оплаты работы подрядчика.'
                    });
                    
                    additionalStages.push({
                        number: (stageCounter + 1).toString(),
                        name: 'Покраска',
                        duration: 'В течение ' + data.painting_duration + ' ' + getDayWord(data.painting_duration) + ' после оплаты',
                        cost: 'Включено в стоимость покраски',
                        condition: 'Фактом утверждения этапа является отправка фото готового изделия Исполнителем. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от услуги после оплаты невозможен, возврат средств не производится.'
                    });
                    
                    additionalServicesHTML += '<p><strong>Услуга покраски:</strong> ' + data.painting_cost + ' руб. (100% предоплата)</p>';
                }

                // Заполняем оферту
                document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                document.getElementById('purposeDisplay').textContent = data.purpose;
                document.getElementById('fileFormatDisplay').textContent = data.file_format;
                document.getElementById('totalCostDisplay').textContent = data.total_cost;
                document.getElementById('correctionsCostDisplay').textContent = data.corrections_cost;
                document.getElementById('bankDetailsDisplay').textContent = data.bank_details;
                document.getElementById('additionalServicesSection').innerHTML = additionalServicesHTML;

                // Устанавливаем дату договора
                var now = new Date();
                document.getElementById('contractDay').textContent = now.getDate();
                document.getElementById('contractMonth').textContent = getMonthName(now.getMonth());
                document.getElementById('contractYear').textContent = now.getFullYear();

                // Заполняем таблицу основных этапов
                var tableBody = document.getElementById('stagesTableBody');
                tableBody.innerHTML = '';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    var row = '<tr><td>' + stage.number + '</td><td>' + stage.name + '</td><td>' + stage.duration + '</td><td>' + stage.cost + '</td><td>' + stage.condition + '</td></tr>';
                    tableBody.innerHTML += row;
                }

                // Заполняем таблицу дополнительных этапов
                var additionalTable = document.getElementById('additionalStagesTable');
                additionalTable.innerHTML = '';
                
                if (additionalStages.length > 0) {
                    var additionalHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><tbody>';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        additionalHTML += '<tr><td>' + additionalStage.number + '</td><td>' + additionalStage.name + '</td><td>' + additionalStage.duration + '</td><td>' + additionalStage.cost + '</td><td>' + additionalStage.condition + '</td></tr>';
                    }
                    additionalHTML += '</tbody></table>';
                    additionalTable.innerHTML = additionalHTML;
                }

                // Сохраняем данные
                window.currentOfferData = data;
                window.currentStages = stages;
                window.additionalStages = additionalStages;

                // Показываем результат
                showOffer();
                showMessage('ТЗ-оферта успешно создана!');
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        function showOffer() {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('offerView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showForm() {
            document.getElementById('offerView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showMessage(text, isError) {
            var messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (isError) {
                messageEl.className = 'message error';
            } else {
                messageEl.className = 'message';
            }
            
            setTimeout(function() {
                messageEl.style.display = 'none';
            }, 4000);
        }

        function shareAsText() {
            try {
                var data = window.currentOfferData;
                var stages = window.currentStages;
                var additionalStages = window.additionalStages;
                
                // Рассчитываем стоимость этапов
                var stage1Cost = Math.round(data.total_cost * 0.2);
                var stage2Cost = Math.round(data.total_cost * 0.3);
                var stage3Cost = data.total_cost - stage1Cost - stage2Cost;
                
                var text = 'ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)\n';
                text += 'к Договору на создание 3D-модели\n\n';
                
                text += 'Техническое задание № ' + data.project_number + '\n';
                text += 'Проект: ' + data.project_name + '\n\n';
                
                text += '1. Цель и назначение модели\n';
                text += data.purpose + '\n\n';
                
                text += '2. Исходные данные\n';
                text += '- Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.\n';
                text += '- Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.\n\n';
                
                text += '3. Технические требования к модели\n';
                text += '- Итоговый файл предоставляется в формате ' + data.file_format + ', готовом к 3D-печати.\n';
                text += '- Модель оптимизирована для процесса FDM/SLA печати.\n';
                text += '- Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство.\n\n';
                
                text += '4. Визуальные критерии (Критерии оценки)\n';
                text += 'Результат считается соответствующим ТЗ при совпадении по объективным параметрам.\n';
                text += '- Силуэт: узнаваем и сопоставим с исходным изображением\n';
                text += '- Крупные детали: соответствуют референсу\n';
                text += '- Поза: соответствует референсу\n';
                text += '- Композиция: соответствует референсу\n';
                text += '- Мелкая детализация: на усмотрение Исполнителя\n\n';
                
                text += '5. Порядок приемки работы\n';
                text += '- Результаты каждого этапа направляются Заказчику\n';
                text += '- Обратная связь в виде скриншотов с графическими пометками\n';
                text += '- Текстовые описания без пометок не принимаются\n';
                text += '- Фактом утверждения этапов печати и покраски является отправка фото готового изделия Исполнителем\n\n';
                
                text += 'ДОГОВОР-ОФЕРТА на оказание услуг по созданию 3D-модели\n\n';
                
                text += 'г. Москва «' + new Date().getDate() + '» ' + getMonthName(new Date().getMonth()) + ' ' + new Date().getFullYear() + ' г.\n\n';
                
                text += '1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ\n';
                text += 'Исполнитель: Константин Сергеевич С. предлагает заключить настоящий Договор.\n\n';
                
                text += '2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ\n';
                text += 'Общая стоимость Заказа составляет: ' + data.total_cost + ' рублей.\n\n';
                
                text += 'Этапы работы:\n';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    text += stage.number + '. ' + stage.name + ' | ' + stage.duration + ' | ' + stage.cost + '\n';
                    text += 'Условие: ' + stage.condition + '\n\n';
                }
                
                if (additionalStages.length > 0) {
                    text += 'Дополнительные услуги:\n';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        text += additionalStage.number + '. ' + additionalStage.name + ' | ' + additionalStage.duration + ' | ' + additionalStage.cost + '\n';
                        text += 'Условие: ' + additionalStage.condition + '\n\n';
                    }
                }
                
                text += 'Правки к принятым этапам оплачиваются дополнительно: ' + data.corrections_cost + ' руб./подход\n\n';
                
                text += '3. ПОРЯДОК ОПЛАТЫ\n';
                text += '1. Этап 1: 20% (' + stage1Cost + ' руб.) - оплата в течение 2 рабочих дней с момента отправки предложения\n';
                text += '2. Этап 2: 30% (' + stage2Cost + ' руб.) - оплачивается одновременно с Этапом 1, списывается при передаче эскиза\n';
                text += '3. Этап 3: 50% (' + stage3Cost + ' руб.) - оплачивается в течение 2 рабочих дней с момента утверждения эскиза\n';
                text += '4. Дополнительные услуги: 100% стоимости - оплачивается в течение 2 рабочих дней с момента утверждения модели\n';
                text += '5. Реквизиты для оплаты: ' + data.bank_details + '\n';
                text += '6. Подтверждением оплаты является чек\n\n';
                
                text += '4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ\n';
                text += 'Услуги печати и покраски являются отдельными с 100% предоплатой.\n';
                
                if (data.include_printing) {
                    text += 'Услуга печати: ' + data.printing_cost + ' руб. (100% предоплата)\n';
                }
                if (data.include_painting) {
                    text += 'Услуга покраски: ' + data.painting_cost + ' руб. (100% предоплата)\n';
                }
                
                text += '\n5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ\n';
                text += '1. Оплата означает принятие условий оферты и ТЗ\n';
                text += '2. Правки к принятым этапам оплачиваются дополнительно\n';
                text += '3. Споры решаются путем переговоров, а при недостижении согласия — в суде\n\n';
                
                text += 'Исполнитель: Константин Сергеевич С.\n\n';
                
                text += 'Создано: ' + data.created_at_display;

                // Пытаемся скопировать
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showMessage('Текст скопирован в буфер обмена!');
                    }).catch(function() {
                        showTextForCopy(text);
                    });
                } else {
                    showTextForCopy(text);
                }
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        function showTextForCopy(text) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showMessage('Текст скопирован в буфер обмена!');
            } catch (err) {
                prompt('Скопируйте этот текст:', text);
            }
            
            document.body.removeChild(textArea);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Рассчитываем первоначальную разбивку стоимости
            calculateCostBreakdown();
            
            // Показываем форму
            showForm();
        });
    </script>
</body>
</html>