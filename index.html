<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ТЗ и Договора-оферты для 3D моделей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f0f2f5;
            padding: 15px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #007cba;
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #007cba;
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background: #007cba;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            font-weight: 600;
            margin: 12px 0;
            transition: all 0.3s;
        }
        
        button:active {
            background: #005a87;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:active {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:active {
            background: #1e7e34;
        }
        
        .offer-view {
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007cba;
        }
        
        .document-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .document-title {
            font-weight: 600;
            color: #007cba;
            margin-bottom: 15px;
            font-size: 18px;
            border-left: 4px solid #007cba;
            padding-left: 12px;
        }
        
        .criteria-list {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .criteria-list li {
            margin-bottom: 6px;
        }
        
        .stages-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .stages-table th,
        .stages-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .stages-table th {
            background-color: #007cba;
            color: white;
            font-weight: 600;
        }
        
        .bank-details {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            font-size: 16px;
        }
        
        .message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .optional-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .optional-fields {
            display: none;
            margin-top: 10px;
        }
        
        .link-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007cba;
        }
        
        .link-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
            border: 1px solid #007cba;
        }
        
        .expiry-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .contract-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .contract-info {
            margin-bottom: 15px;
        }
        
        .signature-section {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        .signature {
            width: 45%;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div id="formView" class="container">
        <h1>Генератор ТЗ и Договора-оферты для 3D моделей</h1>
        
        <div class="form-group">
            <label>Название проекта:</label>
            <input type="text" id="project_name" value="3D модель персонажа">
        </div>
        
        <div class="form-group">
            <label>Общая стоимость Заказа (руб.):</label>
            <input type="number" id="total_cost" value="8000">
        </div>
        
        <div class="form-group">
            <label>Цель создания модели:</label>
            <textarea id="purpose">Создание 3D-модели для последующей 3D-печати и коллекционирования.</textarea>
        </div>
        
        <div class="form-group">
            <label>Исходные данные (референсные материалы):</label>
            <textarea id="photos_description">Фотографии, эскизы, предоставленные Заказчиком</textarea>
        </div>
        
        <div class="optional-section">
            <h3>Сроки выполнения этапов</h3>
            
            <div class="form-group">
                <label>Дата утверждения ТЗ:</label>
                <input type="text" id="stage1_date" placeholder="ДД.ММ.ГГГГ" value="14.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата утверждения 3D-эскиза:</label>
                <input type="text" id="stage2_date" placeholder="ДД.ММ.ГГГГ" value="16.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата передачи файла STL:</label>
                <input type="text" id="stage3_date" placeholder="ДД.ММ.ГГГГ" value="18.11.2025">
            </div>
        </div>
        
        <div class="optional-section">
            <h3>Дополнительные услуги</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_printing" onchange="togglePrintingFields()">
                <label for="include_printing">Включить услугу 3D-печати</label>
            </div>
            
            <div id="printing_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость печати (руб.):</label>
                    <input type="number" id="printing_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения печати:</label>
                    <input type="text" id="printing_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_painting" onchange="togglePaintingFields()">
                <label for="include_painting">Включить услугу покраски</label>
            </div>
            
            <div id="painting_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость покраски (руб.):</label>
                    <input type="number" id="painting_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения покраски:</label>
                    <input type="text" id="painting_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
        </div>
        
        <button onclick="generateOffer()">Сгенерировать документы</button>
    </div>

    <div id="offerView" class="container offer-view">
        <div class="header">
            <h1>ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)<br>к Договору на создание 3D-модели</h1>
            <p id="createdAt"></p>
        </div>

        <div class="document-section">
            <div class="document-title">1. Цель и назначение модели</div>
            <p id="purposeDisplay"></p>
        </div>

        <div class="document-section">
            <div class="document-title">2. Исходные данные</div>
            <p>· Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.</p>
            <p>· Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.</p>
            <p id="photosDescriptionDisplay"></p>
        </div>

        <div class="document-section">
            <div class="document-title">3. Технические требования к модели</div>
            <p>· Итоговый файл предоставляется в формате STL, готовом к 3D-печати.</p>
            <p>· Модель оптимизирована для процесса FDM/SLA печати (удаление невидимых полигонов, обеспечение целостности сетки).</p>
            <p>· Важное условие: Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство, а не созданием его точной фотометрической копии. Восприятие объема, пропорций и деталей может отличаться от исходного плоского изображения в силу технических особенностей процесса.</p>
        </div>

        <div class="document-section">
            <div class="document-title">4. Визуальные критерии (Критерии оценки)</div>
            <p>Результат считается соответствующим ТЗ при совпадении по следующим объективным параметрам (допускаются незначительные отклонения, обусловленные переводом из 2D в 3D):</p>
            <ul class="criteria-list">
                <li><strong>Силуэт:</strong> Общий контур и пропорции модели соответствуют референсу. Допускаются незначительные отклонения, связанные с интерпретацией перспективы и объема.</li>
                <li><strong>Крупные детали:</strong> Расположение и общая форма основных элементов (одежда, снаряжение, черты лица, прическа) соответствуют референсу.</li>
                <li><strong>Поза:</strong> Ракурс и положение тела/объекта соответствуют референсу.</li>
                <li><strong>Композиция:</strong> Расположение элементов модели в пространстве соответствует референсу.</li>
            </ul>
            <p>Мелкая детализация (текстуры, складки, узоры) выполняется на усмотрение Исполнителя в рамках общего стиля и не является отдельным критерием приемки.</p>
        </div>

        <div class="document-section">
            <div class="document-title">5. Порядок приемки работы (Процедура предоставления обратной связи)</div>
            <p>· Результаты каждого этапа работы направляются Заказчику для ознакомления.</p>
            <p>· При наличии замечаний, Заказчик обязуется предоставить обратную связь в виде скриншотов с четкими графическими пометками (стрелки, кружки), поясняющими характер правки.</p>
            <p>· Текстовые описания правок без визуальных пометок к рассмотрению не принимаются.</p>
        </div>

        <div style="page-break-before: always;"></div>

        <div class="contract-header">
            <h1>ДОГОВОР-ОФЕРТА<br>на оказание услуг по созданию 3D-модели</h1>
            <p>г. Москва «<span id="contractDay">12</span>» <span id="contractMonth">ноября</span> 2025 г.</p>
        </div>

        <div class="contract-info">
            <p>Исполнитель: Константин Сергеевич С., предлагает заключить настоящий Договор любому физическому или юридическому лицу (далее — Заказчик) на следующих условиях. Акцепт оферты (подтверждение заказа) осуществляется путем 100% предоплаты в течение 3 (трех) рабочих дней с момента ее получения. По истечении данного срока условия (сроки и стоимость) подлежат повторному согласованию.</p>
        </div>

        <div class="document-section">
            <div class="document-title">1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ</div>
            <p>Исполнитель обязуется создать 3D-модель в соответствии с Техническим заданием (ТЗ), а Заказчик — принять и оплатить работу.</p>
        </div>

        <div class="document-section">
            <div class="document-title">2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ</div>
            <p>Общая стоимость Заказа составляет <span id="totalCostDisplay" style="font-weight: bold;"></span> рублей.</p>
            
            <table class="stages-table">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Наименование этапа</th>
                        <th>Срок исполнения*</th>
                        <th>Стоимость этапа</th>
                        <th>Условие подтверждения/оплаты</th>
                    </tr>
                </thead>
                <tbody id="stagesTableBody">
                </tbody>
            </table>
            <p><em>*Сроки могут быть скорректированы по согласованию Сторон.</em></p>
        </div>

        <div class="document-section">
            <div class="document-title">3. ПОРЯДОК ОПЛАТЫ</div>
            <p id="paymentConditions"></p>
            <div class="bank-details">
                <p><strong>Реквизиты для оплаты:</strong></p>
                <p>· Перевод по СБП на номер: 89777145325</p>
                <p>· Банк: Т-Банк</p>
                <p>· Получатель: Константин Сергеевич С.</p>
                <p>· Подтверждением оплаты является чек.</p>
            </div>
        </div>

        <div class="document-section">
            <div class="document-title">4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ</div>
            <p>Услуги 3D-печати и покраски являются отдельными, не зависящими от создания модели, и отражаются в ТЗ как самостоятельные этапы с отдельной 100% предоплатой. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от данных услуг после их оплаты невозможен, возврат средств не производится.</p>
            <div id="additionalServicesTable"></div>
        </div>

        <div class="document-section">
            <div class="document-title">5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ</div>
            <p>1. Оплата Заказа означает полное и безоговорочное принятие Заказчиком всех условий настоящего Договора-оферты и прилагаемого ТЗ.</p>
            <p>2. Все правки к этапам, ранее принятым Заказчиком (в соответствии с п.2), оплачиваются дополнительно по отдельному соглашению.</p>
            <p>3. Все споры Стороны решают путем переговоров, а при недостижении согласия — в суде по месту нахождения Исполнителя.</p>
        </div>

        <div class="signature-section">
            <div class="signature">
                <p>_________________________</p>
                <p>Константин Сергеевич С.</p>
                <p>Исполнитель</p>
            </div>
            <div class="signature">
                <p>_________________________</p>
                <p>Заказчик</p>
            </div>
        </div>

        <div class="link-section no-print">
            <div class="document-title">Ссылка для передачи документов</div>
            <p>Отправьте эту ссылку клиенту. Ссылка будет активна в течение 30 дней.</p>
            <div class="link-box" id="offerLink"></div>
            <div class="expiry-info" id="expiryInfo"></div>
            <button onclick="copyOfferLink()">Скопировать ссылку</button>
        </div>

        <div class="no-print">
            <button class="btn-success" onclick="window.print()">Распечатать документы</button>
            <button class="btn-secondary" onclick="showForm()">Создать новые документы</button>
            <button onclick="shareAsText()">Поделиться как текст</button>
        </div>
        
        <div class="message" id="message"></div>
    </div>

    <script>
        // Функции для показа/скрытия дополнительных полей
        function togglePrintingFields() {
            var printingFields = document.getElementById('printing_fields');
            printingFields.style.display = document.getElementById('include_printing').checked ? 'block' : 'none';
        }
        
        function togglePaintingFields() {
            var paintingFields = document.getElementById('painting_fields');
            paintingFields.style.display = document.getElementById('include_painting').checked ? 'block' : 'none';
        }

        // Функция для кодирования данных в base64
        function encodeData(data) {
            return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        }

        // Функция для декодирования данных из base64
        function decodeData(encoded) {
            return JSON.parse(decodeURIComponent(escape(atob(encoded))));
        }

        // Функция для проверки срока действия ссылки
        function isLinkExpired(createdAt) {
            var created = new Date(createdAt);
            var now = new Date();
            var diffDays = Math.floor((now - created) / (1000 * 60 * 60 * 24));
            return diffDays > 30; // Ссылка действительна 30 дней
        }

        // Функция для форматирования даты
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU');
        }

        // Функция для получения названия месяца
        function getMonthName(month) {
            var months = [
                'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
            ];
            return months[month];
        }

        // Основная функция генерации документов
        function generateOffer() {
            try {
                // Собираем данные
                var data = {
                    project_name: document.getElementById('project_name').value,
                    total_cost: parseInt(document.getElementById('total_cost').value) || 8000,
                    purpose: document.getElementById('purpose').value,
                    photos_description: document.getElementById('photos_description').value,
                    // Сроки этапов
                    stage1_date: document.getElementById('stage1_date').value,
                    stage2_date: document.getElementById('stage2_date').value,
                    stage3_date: document.getElementById('stage3_date').value,
                    // Дополнительные услуги
                    include_printing: document.getElementById('include_printing').checked,
                    printing_cost: parseInt(document.getElementById('printing_cost').value) || 0,
                    printing_date: document.getElementById('printing_date').value,
                    include_painting: document.getElementById('include_painting').checked,
                    painting_cost: parseInt(document.getElementById('painting_cost').value) || 0,
                    painting_date: document.getElementById('painting_date').value,
                    // Метаданные
                    created_at: new Date().toISOString(),
                    version: '1.0'
                };

                // Генерируем номер и дату
                data.project_number = 'PROJ-' + new Date().getTime();
                data.created_at_display = new Date().toLocaleString('ru-RU');
                
                // Устанавливаем дату для договора
                var now = new Date();
                document.getElementById('contractDay').textContent = now.getDate();
                document.getElementById('contractMonth').textContent = getMonthName(now.getMonth());

                // Рассчитываем основные этапы
                var stage1_cost = Math.round(data.total_cost * 0.2);
                var stage2_cost = Math.round(data.total_cost * 0.3);
                var stage3_cost = data.total_cost - stage1_cost - stage2_cost; // Оставшиеся 50%
                
                var stages = [
                    {
                        name: 'Утверждение ТЗ',
                        date: data.stage1_date,
                        cost: stage1_cost + ' руб.',
                        condition: 'Внесение предоплаты.'
                    },
                    {
                        name: 'Утверждение 3D-эскиза',
                        date: data.stage2_date,
                        cost: stage2_cost + ' руб.',
                        condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки результатов этапа, работа считается принятой. Очередной платеж подлежит уплате в течение 48 часов с момента принятия этапа.'
                    },
                    {
                        name: 'Передача файла STL',
                        date: data.stage3_date,
                        cost: stage3_cost + ' руб.',
                        condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки финальных скриншотов, работа считается принятой, Заказчик обязан произвести итоговый платеж (если применимо) в течение 48 часов.'
                    }
                ];

                // Дополнительные этапы
                var additionalStages = [];
                if (data.include_printing) {
                    additionalStages.push({
                        name: '3D-печать',
                        date: data.printing_date,
                        cost: data.printing_cost + ' руб.',
                        condition: '100% предоплата. Отказ от услуги после оплаты невозможен.'
                    });
                }
                
                if (data.include_painting) {
                    additionalStages.push({
                        name: 'Покраска',
                        date: data.painting_date,
                        cost: data.painting_cost + ' руб.',
                        condition: '100% предоплата. Отказ от услуги после оплаты невозможен.'
                    });
                }

                // Заполняем документы
                document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                document.getElementById('createdAt').textContent = 'Создано: ' + data.created_at_display;
                document.getElementById('purposeDisplay').textContent = data.purpose;
                document.getElementById('photosDescriptionDisplay').textContent = data.photos_description;
                document.getElementById('totalCostDisplay').textContent = data.total_cost;

                // Определяем условия оплаты
                var paymentConditions = '';
                if (data.total_cost <= 10000) {
                    paymentConditions = '1. При общей стоимости Заказа до 10 000 ₽ — 100% предоплата.';
                } else {
                    paymentConditions = '1. При общей стоимости Заказа свыше 10 000 ₽ — 50% предоплата, 50% после завершения Этапа 3.';
                }
                document.getElementById('paymentConditions').textContent = paymentConditions;

                // Заполняем таблицу основных этапов
                var tableBody = document.getElementById('stagesTableBody');
                tableBody.innerHTML = '';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    var row = '<tr>' +
                        '<td>' + (i+1) + '</td>' +
                        '<td>' + stage.name + '</td>' +
                        '<td>' + stage.date + '</td>' +
                        '<td>' + stage.cost + '</td>' +
                        '<td>' + stage.condition + '</td>' +
                        '</tr>';
                    tableBody.innerHTML += row;
                }

                // Заполняем таблицу дополнительных этапов
                var additionalTable = document.getElementById('additionalServicesTable');
                additionalTable.innerHTML = '';
                
                if (additionalStages.length > 0) {
                    var additionalHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><thead><tr><th>Наименование услуги</th><th>Срок исполнения</th><th>Стоимость</th><th>Условия</th></tr></thead><tbody>';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        additionalHTML += '<tr><td>' + additionalStage.name + '</td><td>' + additionalStage.date + '</td><td>' + additionalStage.cost + '</td><td>' + additionalStage.condition + '</td></tr>';
                    }
                    additionalHTML += '</tbody></table>';
                    additionalTable.innerHTML = additionalHTML;
                }

                // Генерируем уникальную ссылку
                var encodedData = encodeData(data);
                var currentUrl = window.location.href.split('?')[0]; // Берем базовый URL без параметров
                var offerLink = currentUrl + '?offer=' + encodedData;
                
                // Показываем ссылку
                document.getElementById('offerLink').textContent = offerLink;
                
                // Показываем информацию о сроке действия
                var expiryDate = new Date(data.created_at);
                expiryDate.setDate(expiryDate.getDate() + 30);
                document.getElementById('expiryInfo').textContent = 'Ссылка действительна до: ' + formatDate(expiryDate);

                // Сохраняем данные
                window.currentOfferData = data;
                window.currentStages = stages;
                window.additionalStages = additionalStages;
                window.currentOfferLink = offerLink;

                // Показываем результат
                showOffer();
                showMessage('Документы успешно созданы!');
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        // Функция для копирования ссылки
        function copyOfferLink() {
            if (window.currentOfferLink) {
                navigator.clipboard.writeText(window.currentOfferLink).then(function() {
                    showMessage('Ссылка скопирована в буфер обмена!');
                }).catch(function() {
                    showTextForCopy(window.currentOfferLink);
                });
            }
        }

        // Функция для загрузки документов из URL параметров
        function loadOfferFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var offerParam = urlParams.get('offer');
            
            if (offerParam) {
                try {
                    var data = decodeData(offerParam);
                    
                    // Проверяем срок действия
                    if (isLinkExpired(data.created_at)) {
                        showMessage('Ссылка устарела! Создайте новые документы.', true);
                        return;
                    }
                    
                    // Устанавливаем дату для договора
                    var createdDate = new Date(data.created_at);
                    document.getElementById('contractDay').textContent = createdDate.getDate();
                    document.getElementById('contractMonth').textContent = getMonthName(createdDate.getMonth());
                    
                    // Заполняем документы данными из URL
                    document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                    document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                    document.getElementById('createdAt').textContent = 'Создано: ' + data.created_at_display;
                    document.getElementById('purposeDisplay').textContent = data.purpose;
                    document.getElementById('photosDescriptionDisplay').textContent = data.photos_description;
                    document.getElementById('totalCostDisplay').textContent = data.total_cost;

                    // Определяем условия оплаты
                    var paymentConditions = '';
                    if (data.total_cost <= 10000) {
                        paymentConditions = '1. При общей стоимости Заказа до 10 000 ₽ — 100% предоплата.';
                    } else {
                        paymentConditions = '1. При общей стоимости Заказа свыше 10 000 ₽ — 50% предоплата, 50% после завершения Этапа 3.';
                    }
                    document.getElementById('paymentConditions').textContent = paymentConditions;

                    // Рассчитываем этапы
                    var stage1_cost = Math.round(data.total_cost * 0.2);
                    var stage2_cost = Math.round(data.total_cost * 0.3);
                    var stage3_cost = data.total_cost - stage1_cost - stage2_cost; // Оставшиеся 50%
                    
                    var stages = [
                        {
                            name: 'Утверждение ТЗ',
                            date: data.stage1_date,
                            cost: stage1_cost + ' руб.',
                            condition: 'Внесение предоплаты.'
                        },
                        {
                            name: 'Утверждение 3D-эскиза',
                            date: data.stage2_date,
                            cost: stage2_cost + ' руб.',
                            condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки результатов этапа, работа считается принятой. Очередной платеж подлежит уплате в течение 48 часов с момента принятия этапа.'
                        },
                        {
                            name: 'Передача файла STL',
                            date: data.stage3_date,
                            cost: stage3_cost + ' руб.',
                            condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки финальных скриншотов, работа считается принятой, Заказчик обязан произвести итоговый платеж (если применимо) в течение 48 часов.'
                        }
                    ];

                    // Заполняем таблицу основных этапов
                    var tableBody = document.getElementById('stagesTableBody');
                    tableBody.innerHTML = '';
                    for (var i = 0; i < stages.length; i++) {
                        var stage = stages[i];
                        var row = '<tr>' +
                            '<td>' + (i+1) + '</td>' +
                            '<td>' + stage.name + '</td>' +
                            '<td>' + stage.date + '</td>' +
                            '<td>' + stage.cost + '</td>' +
                            '<td>' + stage.condition + '</td>' +
                            '</tr>';
                        tableBody.innerHTML += row;
                    }

                    // Дополнительные этапы
                    var additionalTable = document.getElementById('additionalServicesTable');
                    additionalTable.innerHTML = '';
                    
                    if (data.include_printing) {
                        var printingHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><thead><tr><th>Наименование услуги</th><th>Срок исполнения</th><th>Стоимость</th><th>Условия</th></tr></thead><tbody>';
                        printingHTML += '<tr><td>3D-печать</td><td>' + data.printing_date + '</td><td>' + data.printing_cost + ' руб.</td><td>100% предоплата. Отказ от услуги после оплаты невозможен.</td></tr>';
                        
                        if (data.include_painting) {
                            printingHTML += '<tr><td>Покраска</td><td>' + data.painting_date + '</td><td>' + data.painting_cost + ' руб.</td><td>100% предоплата. Отказ от услуги после оплаты невозможен.</td></tr>';
                        }
                        
                        printingHTML += '</tbody></table>';
                        additionalTable.innerHTML = printingHTML;
                    } else if (data.include_painting) {
                        var paintingHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><thead><tr><th>Наименование услуги</th><th>Срок исполнения</th><th>Стоимость</th><th>Условия</th></tr></thead><tbody>';
                        paintingHTML += '<tr><td>Покраска</td><td>' + data.painting_date + '</td><td>' + data.painting_cost + ' руб.</td><td>100% предоплата. Отказ от услуги после оплаты невозможен.</td></tr>';
                        paintingHTML += '</tbody></table>';
                        additionalTable.innerHTML = paintingHTML;
                    }

                    // Скрываем секцию с ссылкой при просмотре по ссылке
                    document.querySelector('.link-section').style.display = 'none';
                    
                    // Показываем документы
                    showOffer();
                    
                } catch (error) {
                    console.error('Ошибка загрузки документов:', error);
                    showMessage('Не удалось загрузить документы по ссылке', true);
                }
            }
        }

        function showOffer() {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('offerView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showForm() {
            document.getElementById('offerView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';
            window.scrollTo(0, 0);
            
            // Очищаем параметры URL
            if (window.history.replaceState) {
                var newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        function showMessage(text, isError) {
            var messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (isError) {
                messageEl.className = 'message error';
            } else {
                messageEl.className = 'message';
            }
            
            setTimeout(function() {
                messageEl.style.display = 'none';
            }, 4000);
        }

        function shareAsText() {
            try {
                var data = window.currentOfferData;
                var stages = window.currentStages;
                var additionalStages = window.additionalStages;
                
                var text = 'ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)\nк Договору на создание 3D-модели\n\n';
                
                text += '1. Цель и назначение модели\n';
                text += data.purpose + '\n\n';
                
                text += '2. Исходные данные\n';
                text += '· Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.\n';
                text += '· Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.\n\n';
                
                text += '3. Технические требования к модели\n';
                text += '· Итоговый файл предоставляется в формате STL, готовом к 3D-печати.\n';
                text += '· Модель оптимизирована для процесса FDM/SLA печати (удаление невидимых полигонов, обеспечение целостности сетки).\n';
                text += '· Важное условие: Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство, а не созданием его точной фотометрической копии. Восприятие объема, пропорций и деталей может отличаться от исходного плоского изображения в силу технических особенностей процесса.\n\n';
                
                text += '4. Визуальные критерии (Критерии оценки)\n';
                text += 'Результат считается соответствующим ТЗ при совпадении по следующим объективным параметрам (допускаются незначительные отклонения, обусловленные переводом из 2D в 3D):\n';
                text += '1. Силуэт: Общий контур и пропорции модели соответствуют референсу. Допускаются незначительные отклонения, связанные с интерпретацией перспективы и объема.\n';
                text += '2. Крупные детали: Расположение и общая форма основных элементов (одежда, снаряжение, черты лица, прическа) соответствуют референсу.\n';
                text += '3. Поза: Ракурс и положение тела/объекта соответствуют референсу.\n';
                text += '4. Композиция: Расположение элементов модели в пространстве соответствует референсу.\n\n';
                text += 'Мелкая детализация (текстуры, складки, узоры) выполняется на усмотрение Исполнителя в рамках общего стиля и не является отдельным критерием приемки.\n\n';
                
                text += '5. Порядок приемки работы (Процедура предоставления обратной связи)\n';
                text += '· Результаты каждого этапа работы направляются Заказчику для ознакомления.\n';
                text += '· При наличии замечаний, Заказчик обязуется предоставить обратную связь в виде скриншотов с четкими графическими пометками (стрелки, кружки), поясняющими характер правки.\n';
                text += '· Текстовые описания правок без визуальных пометок к рассмотрению не принимаются.\n\n';
                
                text += '---\n\n';
                
                text += 'ДОГОВОР-ОФЕРТА\nна оказание услуг по созданию 3D-модели\n\n';
                
                text += 'г. Москва «' + document.getElementById('contractDay').textContent + '» ' + document.getElementById('contractMonth').textContent + ' 2025 г.\n\n';
                
                text += 'Исполнитель: Константин Сергеевич С., предлагает заключить настоящий Договор любому физическому или юридическому лицу (далее — Заказчик) на следующих условиях. Акцепт оферты (подтверждение заказа) осуществляется путем 100% предоплаты в течение 3 (трех) рабочих дней с момента ее получения. По истечении данного срока условия (сроки и стоимость) подлежат повторному согласованию.\n\n';
                
                text += '1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ\n';
                text += 'Исполнитель обязуется создать 3D-модель в соответствии с Техническим заданием (ТЗ), а Заказчик — принять и оплатить работу.\n\n';
                
                text += '2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ\n';
                text += 'Общая стоимость Заказа составляет ' + data.total_cost + ' рублей.\n\n';
                
                text += 'Этапы работы:\n';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    text += (i+1) + '. ' + stage.name + ' | ' + stage.date + ' | ' + stage.cost + ' | ' + stage.condition + '\n';
                }
                
                if (additionalStages.length > 0) {
                    text += '\nДополнительные услуги:\n';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        text += additionalStage.name + ' | ' + additionalStage.date + ' | ' + additionalStage.cost + ' | ' + additionalStage.condition + '\n';
                    }
                }
                
                text += '\n*Сроки могут быть скорректированы по согласованию Сторон.\n\n';
                
                text += '3. ПОРЯДОК ОПЛАТЫ\n';
                if (data.total_cost <= 10000) {
                    text += '1. При общей стоимости Заказа до 10 000 ₽ — 100% предоплата.\n';
                } else {
                    text += '1. При общей стоимости Заказа свыше 10 000 ₽ — 50% предоплата, 50% после завершения Этапа 3.\n';
                }
                text += 'Реквизиты для оплаты:\n';
                text += '· Перевод по СБП на номер: 89777145325\n';
                text += '· Банк: Т-Банк\n';
                text += '· Получатель: Константин Сергеевич С.\n';
                text += '· Подтверждением оплаты является чек.\n\n';
                
                text += '4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ\n';
                text += 'Услуги 3D-печати и покраски являются отдельными, не зависящими от создания модели, и отражаются в ТЗ как самостоятельные этапы с отдельной 100% предоплатой. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от данных услуг после их оплаты невозможен, возврат средств не производится.\n\n';
                
                text += '5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ\n';
                text += '1. Оплата Заказа означает полное и безоговорочное принятие Заказчиком всех условий настоящего Договора-оферты и прилагаемого ТЗ.\n';
                text += '2. Все правки к этапам, ранее принятым Заказчиком (в соответствии с п.2), оплачиваются дополнительно по отдельному соглашению.\n';
                text += '3. Все споры Стороны решают путем переговоров, а при недостижении согласия — в суде по месту нахождения Исполнителя.\n\n';
                
                text += '---\n\n';
                
                text += 'Исполнитель:\nКонстантин Сергеевич С.\n\n';
                
                text += 'Создано: ' + data.created_at_display;

                // Пытаемся скопировать
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showMessage('Текст скопирован в буфер обмена!');
                    }).catch(function() {
                        showTextForCopy(text);
                    });
                } else {
                    showTextForCopy(text);
                }
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        function showTextForCopy(text) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showMessage('Текст скопирован в буфер обмена!');
            } catch (err) {
                prompt('Скопируйте этот текст:', text);
            }
            
            document.body.removeChild(textArea);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Пытаемся загрузить документы из URL параметров
            loadOfferFromURL();
            
            // Если документы не загружены из URL, показываем форму
            if (document.getElementById('formView').style.display !== 'none') {
                showForm();
            }
        });
    </script>
</body>
</html>