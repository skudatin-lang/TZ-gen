<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ТЗ-оферты для 3D моделей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f0f2f5;
            padding: 15px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #007cba;
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #007cba;
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background: #007cba;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            font-weight: 600;
            margin: 12px 0;
            transition: all 0.3s;
        }
        
        button:active {
            background: #005a87;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:active {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:active {
            background: #1e7e34;
        }
        
        .offer-view {
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007cba;
        }
        
        .project-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: 600;
            color: #007cba;
            margin-bottom: 8px;
            font-size: 18px;
            border-left: 4px solid #007cba;
            padding-left: 12px;
        }
        
        .criteria-list {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .criteria-list li {
            margin-bottom: 6px;
        }
        
        .stages-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .stages-table th,
        .stages-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .stages-table th {
            background-color: #007cba;
            color: white;
            font-weight: 600;
        }
        
        .bank-details {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            font-size: 16px;
        }
        
        .message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .optional-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .optional-fields {
            display: none;
            margin-top: 10px;
        }
        
        .link-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007cba;
        }
        
        .link-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
            border: 1px solid #007cba;
        }
        
        .expiry-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="formView" class="container">
        <h1>Генератор ТЗ-оферты для 3D моделей</h1>
        
        <div class="form-group">
            <label>Название проекта:</label>
            <input type="text" id="project_name" value="3D модель персонажа">
        </div>
        
        <div class="form-group">
            <label>Общая стоимость моделирования (руб.):</label>
            <input type="number" id="total_cost" value="2500">
        </div>
        
        <div class="form-group">
            <label>Формат файла:</label>
            <select id="file_format">
                <option value=".stl" selected>.stl</option>
                <option value=".obj">.obj</option>
                <option value=".fbx">.fbx</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Размер модели:</label>
            <input type="text" id="model_height" value="150 мм">
        </div>
        
        <div class="form-group">
            <label>Цель использования:</label>
            <textarea id="purpose">Для самостоятельной печати. Нужен готовый к печати файл.</textarea>
        </div>
        
        <div class="form-group">
            <label>Исходные данные (фото):</label>
            <textarea id="photos_description">8 фото с разных ракурсов</textarea>
        </div>
        
        <div class="form-group">
            <label>Стоимость правок (руб./подход):</label>
            <input type="number" id="corrections_cost" value="500">
        </div>
        
        <div class="form-group">
            <label>Время на приемку (часов):</label>
            <input type="number" id="acceptance_hours" value="48">
        </div>
        
        <div class="optional-section">
            <h3>Сроки выполнения этапов</h3>
            
            <div class="form-group">
                <label>Дата утверждения ТЗ:</label>
                <input type="text" id="stage1_date" placeholder="ДД.ММ.ГГГГ" value="14.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата утверждения 3D-эскиза:</label>
                <input type="text" id="stage2_date" placeholder="ДД.ММ.ГГГГ" value="16.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата утверждения модели и передачи файла:</label>
                <input type="text" id="stage3_date" placeholder="ДД.ММ.ГГГГ" value="18.11.2025">
            </div>
        </div>
        
        <div class="optional-section">
            <h3>Дополнительные услуги</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_printing" onchange="togglePrintingFields()">
                <label for="include_printing">Включить услугу печати</label>
            </div>
            
            <div id="printing_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость печати (руб.):</label>
                    <input type="number" id="printing_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения печати:</label>
                    <input type="text" id="printing_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_painting" onchange="togglePaintingFields()">
                <label for="include_painting">Включить услугу покраски</label>
            </div>
            
            <div id="painting_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость покраски (руб.):</label>
                    <input type="number" id="painting_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения покраски:</label>
                    <input type="text" id="painting_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Реквизиты для оплаты:</label>
            <textarea id="bank_details">Т-банк Константин Сергеевич С. 89777145325</textarea>
        </div>
        
        <button onclick="generateOffer()">Сгенерировать ТЗ-оферту</button>
    </div>

    <div id="offerView" class="container offer-view">
        <div class="header">
            <h1>ТЕХНИЧЕСКОЕ ЗАДАНИЕ (персональная оферта)</h1>
            <p id="createdAt"></p>
        </div>

        <div class="project-info">
            <strong id="projectNumber"></strong><br>
            <span id="projectNameDisplay"></span>
        </div>

        <div class="section">
            <div class="section-title">1. Предмет договора</div>
            <p>Создание 3D-модели по фото - является арт-интерпретацией (адаптированным переводом 2D в 3D) и может не соответствовать реальной геометрии объекта.</p>
        </div>

        <div class="section">
            <div class="section-title">2. Цель и назначение модели</div>
            <p id="purposeDisplay"></p>
        </div>

        <div class="section">
            <div class="section-title">3. Исходные данные</div>
            <p id="photosDescriptionDisplay"></p>
        </div>

        <div class="section">
            <div class="section-title">4. Технические требования</div>
            <p><strong>Формат файла:</strong> <span id="fileFormatDisplay"></span></p>
            <p><strong>Размер модели:</strong> <span id="modelHeightDisplay"></span></p>
        </div>

        <div class="section">
            <div class="section-title">5. Визуальные критерии</div>
            <p>Критерии для сравнения с исходным фото (допустимы небольшие отклонения):</p>
            <ul class="criteria-list">
                <li>Все крупные детали на модели зафиксированные в ТЗ на приложенных скринах.</li>
                <li>Пропорции расположения деталей</li>
                <li>Силуэт с основного ракурса сопоставим с исходным изображением.</li>
                <li>Мелкая детализация выполняется в свободной манере исполнения и расположении элементов при условии, что их тип и общий характер соответствуют исходным изображением.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">6. Этапы работы и оплата в % от общей суммы</div>
            <table class="stages-table">
                <thead>
                    <tr>
                        <th>Этап</th>
                        <th>Срок</th>
                        <th>%</th>
                        <th>Стоимость</th>
                    </tr>
                </thead>
                <tbody id="stagesTableBody">
                </tbody>
            </table>
            
            <div id="additionalStagesTable"></div>
            
            <p><em>Правки после принятия этапа оплачиваются дополнительно: <span id="correctionsCostDisplay"></span> руб./подход</em></p>
        </div>

        <div class="section">
            <div class="section-title">7. Порядок приемки</div>
            <p>• Уведомление считается отправленным с момента отправки скриншотов</p>
            <p>• Время на замечания - <span id="acceptanceHoursDisplay"></span> часов</p>
            <p>• При отсутствии замечаний работа принимается автоматически</p>
        </div>

        <div class="section">
            <div class="section-title">8. Акцепт</div>
            <p>Оплата = полное и безоговорочное принятие условий оферты.</p>
        </div>

        <div class="section">
            <div class="section-title">Реквизиты для оплаты</div>
            <div class="bank-details" id="bankDetailsDisplay"></div>
        </div>

        <div class="link-section">
            <div class="section-title">Ссылка для передачи оферты</div>
            <p>Отправьте эту ссылку клиенту. Ссылка будет активна в течение 30 дней.</p>
            <div class="link-box" id="offerLink"></div>
            <div class="expiry-info" id="expiryInfo"></div>
            <button onclick="copyOfferLink()">Скопировать ссылку</button>
        </div>

        <button class="btn-success" onclick="window.print()">Распечатать ТЗ</button>
        <button class="btn-secondary" onclick="showForm()">Создать новое ТЗ</button>
        <button onclick="shareAsText()">Поделиться как текст</button>
        
        <div class="message" id="message"></div>
    </div>

    <script>
        // Функции для показа/скрытия дополнительных полей
        function togglePrintingFields() {
            var printingFields = document.getElementById('printing_fields');
            printingFields.style.display = document.getElementById('include_printing').checked ? 'block' : 'none';
        }
        
        function togglePaintingFields() {
            var paintingFields = document.getElementById('painting_fields');
            paintingFields.style.display = document.getElementById('include_painting').checked ? 'block' : 'none';
        }

        // Функция для кодирования данных в base64
        function encodeData(data) {
            return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        }

        // Функция для декодирования данных из base64
        function decodeData(encoded) {
            return JSON.parse(decodeURIComponent(escape(atob(encoded))));
        }

        // Функция для проверки срока действия ссылки
        function isLinkExpired(createdAt) {
            var created = new Date(createdAt);
            var now = new Date();
            var diffDays = Math.floor((now - created) / (1000 * 60 * 60 * 24));
            return diffDays > 30; // Ссылка действительна 30 дней
        }

        // Функция для форматирования даты
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU');
        }

        // Основная функция генерации оферты
        function generateOffer() {
            try {
                // Собираем данные
                var data = {
                    project_name: document.getElementById('project_name').value,
                    total_cost: parseInt(document.getElementById('total_cost').value) || 2500,
                    file_format: document.getElementById('file_format').value,
                    model_height: document.getElementById('model_height').value,
                    purpose: document.getElementById('purpose').value,
                    photos_description: document.getElementById('photos_description').value,
                    corrections_cost: parseInt(document.getElementById('corrections_cost').value) || 500,
                    acceptance_hours: parseInt(document.getElementById('acceptance_hours').value) || 48,
                    bank_details: document.getElementById('bank_details').value,
                    // Сроки этапов
                    stage1_date: document.getElementById('stage1_date').value,
                    stage2_date: document.getElementById('stage2_date').value,
                    stage3_date: document.getElementById('stage3_date').value,
                    // Дополнительные услуги
                    include_printing: document.getElementById('include_printing').checked,
                    printing_cost: parseInt(document.getElementById('printing_cost').value) || 0,
                    printing_date: document.getElementById('printing_date').value,
                    include_painting: document.getElementById('include_painting').checked,
                    painting_cost: parseInt(document.getElementById('painting_cost').value) || 0,
                    painting_date: document.getElementById('painting_date').value,
                    // Метаданные
                    created_at: new Date().toISOString(),
                    version: '1.0'
                };

                // Генерируем номер
                data.project_number = 'PROJ-' + new Date().getTime();
                data.created_at_display = new Date().toLocaleString('ru-RU');

                // Рассчитываем основные этапы
                var stages = [
                    {
                        name: 'Утверждение ТЗ',
                        percent: '20%',
                        date: data.stage1_date,
                        cost: Math.round(data.total_cost * 0.2) + ' руб.'
                    },
                    {
                        name: 'Утверждение 3D-эскиза',
                        percent: '50%',
                        date: data.stage2_date,
                        cost: Math.round(data.total_cost * 0.5) + ' руб.'
                    },
                    {
                        name: 'Утверждение модели и передача файла',
                        percent: '100%',
                        date: data.stage3_date,
                        cost: data.total_cost + ' руб.'
                    }
                ];

                // Дополнительные этапы
                var additionalStages = [];
                if (data.include_printing) {
                    additionalStages.push({
                        name: 'Печать',
                        percent: '-',
                        date: data.printing_date,
                        cost: data.printing_cost + ' руб.'
                    });
                }
                
                if (data.include_painting) {
                    additionalStages.push({
                        name: 'Покраска',
                        percent: '-',
                        date: data.painting_date,
                        cost: data.painting_cost + ' руб.'
                    });
                }

                // Заполняем оферту
                document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                document.getElementById('createdAt').textContent = 'Создано: ' + data.created_at_display;
                document.getElementById('purposeDisplay').textContent = data.purpose;
                document.getElementById('photosDescriptionDisplay').textContent = data.photos_description;
                document.getElementById('fileFormatDisplay').textContent = data.file_format;
                document.getElementById('modelHeightDisplay').textContent = data.model_height;
                document.getElementById('correctionsCostDisplay').textContent = data.corrections_cost;
                document.getElementById('acceptanceHoursDisplay').textContent = data.acceptance_hours;
                document.getElementById('bankDetailsDisplay').textContent = data.bank_details;

                // Заполняем таблицу основных этапов
                var tableBody = document.getElementById('stagesTableBody');
                tableBody.innerHTML = '';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    var row = '<tr><td>' + stage.name + '</td><td>' + stage.date + '</td><td>' + stage.percent + '</td><td>' + stage.cost + '</td></tr>';
                    tableBody.innerHTML += row;
                }

                // Заполняем таблицу дополнительных этапов
                var additionalTable = document.getElementById('additionalStagesTable');
                additionalTable.innerHTML = '';
                
                if (additionalStages.length > 0) {
                    var additionalHTML = '<table class="stages-table"><tbody>';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        additionalHTML += '<tr><td>' + additionalStage.name + '</td><td>' + additionalStage.date + '</td><td>' + additionalStage.percent + '</td><td>' + additionalStage.cost + '</td></tr>';
                    }
                    additionalHTML += '</tbody></table>';
                    additionalTable.innerHTML = additionalHTML;
                }

                // Генерируем уникальную ссылку
                var encodedData = encodeData(data);
                var offerLink = window.location.origin + window.location.pathname + '?offer=' + encodedData;
                
                // Показываем ссылку
                document.getElementById('offerLink').textContent = offerLink;
                
                // Показываем информацию о сроке действия
                var expiryDate = new Date(data.created_at);
                expiryDate.setDate(expiryDate.getDate() + 30);
                document.getElementById('expiryInfo').textContent = 'Ссылка действительна до: ' + formatDate(expiryDate);

                // Сохраняем данные
                window.currentOfferData = data;
                window.currentStages = stages;
                window.additionalStages = additionalStages;
                window.currentOfferLink = offerLink;

                // Показываем результат
                showOffer();
                showMessage('ТЗ-оферта успешно создана!');
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        // Функция для копирования ссылки
        function copyOfferLink() {
            if (window.currentOfferLink) {
                navigator.clipboard.writeText(window.currentOfferLink).then(function() {
                    showMessage('Ссылка скопирована в буфер обмена!');
                }).catch(function() {
                    showTextForCopy(window.currentOfferLink);
                });
            }
        }

        // Функция для загрузки оферты из URL параметров
        function loadOfferFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var offerParam = urlParams.get('offer');
            
            if (offerParam) {
                try {
                    var data = decodeData(offerParam);
                    
                    // Проверяем срок действия
                    if (isLinkExpired(data.created_at)) {
                        showMessage('Ссылка устарела! Создайте новую ТЗ-оферту.', true);
                        return;
                    }
                    
                    // Заполняем оферту данными из URL
                    document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                    document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                    document.getElementById('createdAt').textContent = 'Создано: ' + data.created_at_display;
                    document.getElementById('purposeDisplay').textContent = data.purpose;
                    document.getElementById('photosDescriptionDisplay').textContent = data.photos_description;
                    document.getElementById('fileFormatDisplay').textContent = data.file_format;
                    document.getElementById('modelHeightDisplay').textContent = data.model_height;
                    document.getElementById('correctionsCostDisplay').textContent = data.corrections_cost;
                    document.getElementById('acceptanceHoursDisplay').textContent = data.acceptance_hours;
                    document.getElementById('bankDetailsDisplay').textContent = data.bank_details;

                    // Рассчитываем этапы
                    var stages = [
                        {
                            name: 'Утверждение ТЗ',
                            percent: '20%',
                            date: data.stage1_date,
                            cost: Math.round(data.total_cost * 0.2) + ' руб.'
                        },
                        {
                            name: 'Утверждение 3D-эскиза',
                            percent: '50%',
                            date: data.stage2_date,
                            cost: Math.round(data.total_cost * 0.5) + ' руб.'
                        },
                        {
                            name: 'Утверждение модели и передача файла',
                            percent: '100%',
                            date: data.stage3_date,
                            cost: data.total_cost + ' руб.'
                        }
                    ];

                    // Заполняем таблицу основных этапов
                    var tableBody = document.getElementById('stagesTableBody');
                    tableBody.innerHTML = '';
                    for (var i = 0; i < stages.length; i++) {
                        var stage = stages[i];
                        var row = '<tr><td>' + stage.name + '</td><td>' + stage.date + '</td><td>' + stage.percent + '</td><td>' + stage.cost + '</td></tr>';
                        tableBody.innerHTML += row;
                    }

                    // Дополнительные этапы
                    var additionalTable = document.getElementById('additionalStagesTable');
                    additionalTable.innerHTML = '';
                    
                    if (data.include_printing) {
                        var printingHTML = '<table class="stages-table"><tbody>';
                        printingHTML += '<tr><td>Печать</td><td>' + data.printing_date + '</td><td>-</td><td>' + data.printing_cost + ' руб.</td></tr>';
                        printingHTML += '</tbody></table>';
                        additionalTable.innerHTML += printingHTML;
                    }
                    
                    if (data.include_painting) {
                        var paintingHTML = '<table class="stages-table"><tbody>';
                        paintingHTML += '<tr><td>Покраска</td><td>' + data.painting_date + '</td><td>-</td><td>' + data.painting_cost + ' руб.</td></tr>';
                        paintingHTML += '</tbody></table>';
                        additionalTable.innerHTML += paintingHTML;
                    }

                    // Скрываем секцию с ссылкой при просмотре по ссылке
                    document.querySelector('.link-section').style.display = 'none';
                    
                    // Показываем оферту
                    showOffer();
                    showMessage('ТЗ-оферта загружена по ссылке');
                    
                } catch (error) {
                    console.error('Ошибка загрузки оферты:', error);
                    showMessage('Не удалось загрузить оферту по ссылке', true);
                }
            }
        }

        function showOffer() {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('offerView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showForm() {
            document.getElementById('offerView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';
            window.scrollTo(0, 0);
            
            // Очищаем параметры URL
            if (window.history.replaceState) {
                var newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        function showMessage(text, isError) {
            var messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (isError) {
                messageEl.className = 'message error';
            } else {
                messageEl.className = 'message';
            }
            
            setTimeout(function() {
                messageEl.style.display = 'none';
            }, 4000);
        }

        function shareAsText() {
            try {
                var data = window.currentOfferData;
                var stages = window.currentStages;
                var additionalStages = window.additionalStages;
                
                var text = 'ТЕХНИЧЕСКОЕ ЗАДАНИЕ (персональная оферта)\n\n';
                text += 'Техническое задание № ' + data.project_number + '\n';
                text += 'Проект: ' + data.project_name + '\n\n';
                
                text += '1. Предмет договора\n';
                text += 'Создание 3D-модели по фото - является арт-интерпретацией (адаптированным переводом 2D в 3D) и может не соответствовать реальной геометрии объекта.\n\n';
                
                text += '2. Цель и назначение модели\n';
                text += data.purpose + '\n\n';
                
                text += '3. Исходные данные\n';
                text += data.photos_description + '\n\n';
                
                text += '4. Технические требования\n';
                text += 'Формат файла: ' + data.file_format + '\n';
                text += 'Размер модели: ' + data.model_height + '\n\n';
                
                text += '5. Визуальные критерии\n';
                text += 'Критерии для сравнения с исходным фото (допустимы небольшие отклонения):\n';
                text += '1. Все крупные детали на модели зафиксированные в ТЗ на приложенных скринах.\n';
                text += '2. Пропорции расположения деталей\n';
                text += '3. Силуэт с основного ракурса сопоставим с исходным изображением.\n';
                text += '4. Мелкая детализация выполняется в свободной манере исполнения и расположении элементов при условии, что их тип и общий характер соответствуют исходным изображением.\n\n';
                
                text += '6. Этапы работы и оплата в % от общей суммы\n';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    text += stage.name + ' | ' + stage.date + ' | ' + stage.percent + ' | ' + stage.cost + '\n';
                }
                
                if (additionalStages.length > 0) {
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        text += additionalStage.name + ' | ' + additionalStage.date + ' | ' + additionalStage.percent + ' | ' + additionalStage.cost + '\n';
                    }
                }
                
                text += '\nПравки после принятия этапа оплачиваются дополнительно: ' + data.corrections_cost + ' руб./подход\n\n';
                
                text += '7. Порядок приемки\n';
                text += '• Уведомление считается отправленным с момента отправки скриншотов\n';
                text += '• Время на замечания - ' + data.acceptance_hours + ' часов\n';
                text += '• При отсутствии замечаний работа принимается автоматически\n\n';
                
                text += '8. Акцепт\n';
                text += 'Оплата = полное и безоговорочное принятие условий оферты.\n\n';
                
                text += 'Реквизиты для оплаты:\n';
                text += data.bank_details + '\n\n';
                
                text += 'Создано: ' + data.created_at_display;

                // Пытаемся скопировать
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showMessage('Текст скопирован в буфер обмена!');
                    }).catch(function() {
                        showTextForCopy(text);
                    });
                } else {
                    showTextForCopy(text);
                }
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        function showTextForCopy(text) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showMessage('Текст скопирован в буфер обмена!');
            } catch (err) {
                prompt('Скопируйте этот текст:', text);
            }
            
            document.body.removeChild(textArea);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Пытаемся загрузить оферту из URL параметров
            loadOfferFromURL();
            
            // Если оферта не загружена из URL, показываем форму
            if (document.getElementById('formView').style.display !== 'none') {
                showForm();
            }
        });
    </script>
</body>
</html>