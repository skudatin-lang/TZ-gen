<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ТЗ-оферты для 3D моделей</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f0f2f5;
            padding: 15px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #007cba;
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #007cba;
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background: #007cba;
            color: white;
            padding: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            font-weight: 600;
            margin: 12px 0;
            transition: all 0.3s;
        }
        
        button:active {
            background: #005a87;
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:active {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:active {
            background: #1e7e34;
        }
        
        .offer-view {
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007cba;
        }
        
        .project-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: 600;
            color: #007cba;
            margin-bottom: 8px;
            font-size: 18px;
            border-left: 4px solid #007cba;
            padding-left: 12px;
        }
        
        .criteria-list {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .criteria-list li {
            margin-bottom: 6px;
        }
        
        .stages-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .stages-table th,
        .stages-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .stages-table th {
            background-color: #007cba;
            color: white;
            font-weight: 600;
        }
        
        .bank-details {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            font-size: 16px;
        }
        
        .message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .optional-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .optional-fields {
            display: none;
            margin-top: 10px;
        }
        
        .link-section {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007cba;
        }
        
        .link-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 14px;
            border: 1px solid #007cba;
        }
        
        .expiry-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .contract-date {
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .contract-closing {
            margin-top: 30px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="formView" class="container">
        <h1>Генератор ТЗ-оферты для 3D моделей</h1>
        
        <div class="form-group">
            <label>Название проекта:</label>
            <input type="text" id="project_name" value="3D модель персонажа">
        </div>
        
        <div class="form-group">
            <label>Общая стоимость моделирования (руб.):</label>
            <input type="number" id="total_cost" value="2500">
        </div>
        
        <div class="form-group">
            <label>Формат файла:</label>
            <select id="file_format">
                <option value=".stl" selected>.stl</option>
                <option value=".obj">.obj</option>
                <option value=".fbx">.fbx</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Размер модели:</label>
            <input type="text" id="model_height" value="150 мм">
        </div>
        
        <div class="form-group">
            <label>Цель использования:</label>
            <textarea id="purpose">Для последующей 3D-печати и коллекционирования.</textarea>
        </div>
        
        <div class="form-group">
            <label>Исходные данные (референсы):</label>
            <textarea id="photos_description">Референсные материалы (фотографии, эскизы), предоставленные Заказчиком. Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.</textarea>
        </div>
        
        <div class="form-group">
            <label>Стоимость правок (руб./подход):</label>
            <input type="number" id="corrections_cost" value="500">
        </div>
        
        <div class="optional-section">
            <h3>Сроки выполнения этапов</h3>
            
            <div class="form-group">
                <label>Дата утверждения ТЗ:</label>
                <input type="text" id="stage1_date" placeholder="ДД.ММ.ГГГГ" value="14.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата утверждения 3D-эскиза:</label>
                <input type="text" id="stage2_date" placeholder="ДД.ММ.ГГГГ" value="16.11.2025">
            </div>
            
            <div class="form-group">
                <label>Дата утверждения модели и передачи файла:</label>
                <input type="text" id="stage3_date" placeholder="ДД.ММ.ГГГГ" value="18.11.2025">
            </div>
        </div>
        
        <div class="optional-section">
            <h3>Дополнительные услуги</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_printing" onchange="togglePrintingFields()">
                <label for="include_printing">Включить услугу печати</label>
            </div>
            
            <div id="printing_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость печати (руб.):</label>
                    <input type="number" id="printing_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения печати:</label>
                    <input type="text" id="printing_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="include_painting" onchange="togglePaintingFields()">
                <label for="include_painting">Включить услугу покраски</label>
            </div>
            
            <div id="painting_fields" class="optional-fields">
                <div class="form-group">
                    <label>Стоимость покраски (руб.):</label>
                    <input type="number" id="painting_cost" value="0">
                </div>
                
                <div class="form-group">
                    <label>Срок выполнения покраски:</label>
                    <input type="text" id="painting_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Реквизиты для оплаты:</label>
            <textarea id="bank_details">Т-банк Константин Сергеевич С. 89777145325</textarea>
        </div>
        
        <button onclick="generateOffer()">Сгенерировать ТЗ-оферту</button>
    </div>

    <div id="offerView" class="container offer-view">
        <div class="header">
            <h1>ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)</h1>
            <h2>к Договору на создание 3D-модели</h2>
        </div>

        <div class="project-info">
            <strong id="projectNumber"></strong><br>
            <span id="projectNameDisplay"></span>
        </div>

        <div class="section">
            <div class="section-title">1. Цель и назначение модели</div>
            <p id="purposeDisplay"></p>
        </div>

        <div class="section">
            <div class="section-title">2. Исходные данные</div>
            <ul class="criteria-list">
                <li>Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.</li>
                <li>Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">3. Технические требования к модели</div>
            <ul class="criteria-list">
                <li>Итоговый файл предоставляется в формате <span id="fileFormatDisplay"></span>, готовом к 3D-печати.</li>
                <li>Модель оптимизирована для процесса FDM/SLA печати (удаление невидимых полигонов, обеспечение целостности сетки).</li>
                <li>Важное условие: Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство, а не созданием его точной фотометрической копии. Восприятие объема, пропорций и деталей может отличаться от исходного плоского изображения в силу технических особенностей процесса.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">4. Визуальные критерии (Критерии оценки)</div>
            <p>Результат считается соответствующим ТЗ при совпадении по следующим объективным параметрам. Допускаются незначительные отклонения, обусловленные переводом из 2D в 3D и техническими требованиями печати.</p>
            <ul class="criteria-list">
                <li><strong>Силуэт:</strong> Считается соответствующим, если он узнаваем и сопоставим с исходным изображением, сохраняя ключевые пропорции. Отличия контура, вызванные интерпретацией перспективы и объема, допустимы.</li>
                <li><strong>Крупные детали:</strong> Расположение и общая форма основных элементов (одежда, снаряжение, черты лица, прическа) соответствуют референсу и в совокупности образуют узнаваемый образ.</li>
                <li><strong>Поза:</strong> Ракурс и положение тела/объекта соответствуют референсу.</li>
                <li><strong>Композиция:</strong> Расположение элементов модели в пространстве соответствует референсу.</li>
                <li><strong>Мелкая детализация</strong> (текстуры, складки, узоры) выполняется на усмотрение Исполнителя в рамках общего стиля и не является отдельным критерием приемки.</li>
            </ul>
            <p>Следующие отклонения считаются допустимыми по умолчанию:</p>
            <ul class="criteria-list">
                <li>Упрощение или укрепление элементов для обеспечения надежности 3D-печати.</li>
                <li>Интерпретация деталей, нечетко видимых или отсутствующих на исходном изображении.</li>
            </ul>
        </div>

        <div class="section">
            <div class="section-title">5. Порядок приемки работы (Процедура предоставления обратной связи)</div>
            <ul class="criteria-list">
                <li>Результаты каждого этапа работы направляются Заказчику для ознакомления.</li>
                <li>При наличии замечаний, Заказчик обязуется предоставить обратную связь в виде скриншотов с четкими графическими пометками (стрелки, кружки), поясняющими характер правки.</li>
                <li>Текстовые описания правок без визуальных пометок к рассмотрению не принимаются.</li>
            </ul>
        </div>

        <div class="header">
            <h1>ДОГОВОР-ОФЕРТА</h1>
            <h2>на оказание услуг по созданию 3D-модели</h2>
        </div>

        <div class="contract-date">
            г. Москва «<span id="contractDay"></span>» <span id="contractMonth"></span> <span id="contractYear"></span> г.
        </div>

        <div class="section">
            <div class="section-title">1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ</div>
            <p>Исполнитель: Константин Сергеевич С., предлагает заключить настоящий Договор любому физическому или юридическому лицу (далее — Заказчик) на следующих условиях. Акцепт оферты (подтверждение заказа) осуществляется путем 100% предоплаты в течение 3 (трех) рабочих дней с момента ее получения. По истечении данного срока условия (сроки и стоимость) подлежат повторному согласованию.</p>
            <p>Исполнитель обязуется создать 3D-модель в соответствии с Техническим заданием (ТЗ), а Заказчик — принять и оплатить работу.</p>
        </div>

        <div class="section">
            <div class="section-title">2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ</div>
            <p>Общая стоимость Заказа составляет: <strong><span id="totalCostDisplay"></span> рублей</strong>.</p>
            
            <table class="stages-table">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Наименование этапа</th>
                        <th>Срок исполнения*</th>
                        <th>Стоимость этапа</th>
                        <th>Условие подтверждения/оплаты</th>
                    </tr>
                </thead>
                <tbody id="stagesTableBody">
                </tbody>
            </table>
            
            <p><em>*Сроки могут быть скорректированы по согласованию Сторон.</em></p>
            
            <div id="additionalStagesTable"></div>
            
            <p><em>Все правки к этапам, ранее принятым Заказчиком, оплачиваются дополнительно: <span id="correctionsCostDisplay"></span> руб./подход</em></p>
        </div>

        <div class="section">
            <div class="section-title">3. ПОРЯДОК ОПЛАТЫ</div>
            <ol class="criteria-list">
                <li>При общей стоимости Заказа до 10 000 ₽ — 100% предоплата.</li>
                <li>При общей стоимости Заказа свыше 10 000 ₽ — 50% предоплата, 50% после завершения Этапа 3.</li>
                <li>Реквизиты для оплаты:
                    <div class="bank-details" id="bankDetailsDisplay"></div>
                </li>
                <li>Подтверждением оплаты является чек.</li>
            </ol>
        </div>

        <div class="section">
            <div class="section-title">4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ</div>
            <p>Услуги 3D-печати и покраски являются отдельными, не зависящими от создания модели, и отражаются в ТЗ как самостоятельные этапы с отдельной 100% предоплатой. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от данных услуг после их оплаты невозможен, возврат средств не производится.</p>
            <div id="additionalServicesSection"></div>
        </div>

        <div class="section">
            <div class="section-title">5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ</div>
            <ol class="criteria-list">
                <li>Оплата Заказа означает полное и безоговорочное принятие Заказчиком всех условий настоящего Договора-оферты и прилагаемого ТЗ.</li>
                <li>Все правки к этапам, ранее принятым Заказчиком (в соответствии с п.2), оплачиваются дополнительно по отдельному соглашению.</li>
                <li>Все споры Стороны решают путем переговоров, а при недостижении согласия — в суде по месту нахождения Исполнителя.</li>
            </ol>
        </div>

        <div class="contract-closing">
            <p><strong>Исполнитель:</strong><br>
            Константин Сергеевич С.</p>
        </div>

        <div class="link-section">
            <div class="section-title">Ссылка для передачи оферты</div>
            <p>Отправьте эту ссылку клиенту. Ссылка будет активна в течение 30 дней.</p>
            <div class="link-box" id="offerLink"></div>
            <div class="expiry-info" id="expiryInfo"></div>
            <button onclick="copyOfferLink()">Скопировать ссылку</button>
        </div>

        <button class="btn-success" onclick="window.print()">Распечатать ТЗ</button>
        <button class="btn-secondary" onclick="showForm()">Создать новое ТЗ</button>
        <button onclick="shareAsText()">Поделиться как текст</button>
        
        <div class="message" id="message"></div>
    </div>

    <script>
        // Функции для показа/скрытия дополнительных полей
        function togglePrintingFields() {
            var printingFields = document.getElementById('printing_fields');
            printingFields.style.display = document.getElementById('include_printing').checked ? 'block' : 'none';
        }
        
        function togglePaintingFields() {
            var paintingFields = document.getElementById('painting_fields');
            paintingFields.style.display = document.getElementById('include_painting').checked ? 'block' : 'none';
        }

        // Функция для кодирования данных в base64
        function encodeData(data) {
            return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        }

        // Функция для декодирования данных из base64
        function decodeData(encoded) {
            return JSON.parse(decodeURIComponent(escape(atob(encoded))));
        }

        // Функция для проверки срока действия ссылки
        function isLinkExpired(createdAt) {
            var created = new Date(createdAt);
            var now = new Date();
            var diffDays = Math.floor((now - created) / (1000 * 60 * 60 * 24));
            return diffDays > 30; // Ссылка действительна 30 дней
        }

        // Функция для форматирования даты
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU');
        }

        // Функция для получения названия месяца
        function getMonthName(month) {
            var months = [
                'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
            ];
            return months[month];
        }

        // Основная функция генерации оферты
        function generateOffer() {
            try {
                // Собираем данные
                var data = {
                    project_name: document.getElementById('project_name').value,
                    total_cost: parseInt(document.getElementById('total_cost').value) || 2500,
                    file_format: document.getElementById('file_format').value,
                    model_height: document.getElementById('model_height').value,
                    purpose: document.getElementById('purpose').value,
                    photos_description: document.getElementById('photos_description').value,
                    corrections_cost: parseInt(document.getElementById('corrections_cost').value) || 500,
                    bank_details: document.getElementById('bank_details').value,
                    // Сроки этапов
                    stage1_date: document.getElementById('stage1_date').value,
                    stage2_date: document.getElementById('stage2_date').value,
                    stage3_date: document.getElementById('stage3_date').value,
                    // Дополнительные услуги
                    include_printing: document.getElementById('include_printing').checked,
                    printing_cost: parseInt(document.getElementById('printing_cost').value) || 0,
                    printing_date: document.getElementById('printing_date').value,
                    include_painting: document.getElementById('include_painting').checked,
                    painting_cost: parseInt(document.getElementById('painting_cost').value) || 0,
                    painting_date: document.getElementById('painting_date').value,
                    // Метаданные
                    created_at: new Date().toISOString(),
                    version: '2.0'
                };

                // Генерируем номер
                data.project_number = 'ТЗ-' + new Date().getTime();
                data.created_at_display = new Date().toLocaleString('ru-RU');

                // Рассчитываем основные этапы
                var stages = [
                    {
                        number: '1',
                        name: 'Утверждение ТЗ',
                        date: data.stage1_date,
                        cost: Math.round(data.total_cost * 0.2) + ' руб. (20%)',
                        condition: 'Внесение предоплаты.'
                    },
                    {
                        number: '2',
                        name: 'Утверждение 3D-эскиза',
                        date: data.stage2_date,
                        cost: Math.round(data.total_cost * 0.3) + ' руб. (30%)',
                        condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки результатов этапа, работа считается принятой. Очередной платеж подлежит уплате в течение 48 часов с момента принятия этапа.'
                    },
                    {
                        number: '3',
                        name: 'Передача файла ' + data.file_format,
                        date: data.stage3_date,
                        cost: Math.round(data.total_cost * 0.5) + ' руб. (50%)',
                        condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки финальных скриншотов, работа считается принятой, Заказчик обязан произвести итоговый платеж (если применимо) в течение 48 часов.'
                    }
                ];

                // Дополнительные этапы
                var additionalStages = [];
                var additionalServicesHTML = '';
                
                if (data.include_printing) {
                    additionalStages.push({
                        number: '4',
                        name: 'Печать',
                        date: data.printing_date,
                        cost: data.printing_cost + ' руб.',
                        condition: '100% предоплата. В связи с заказом физических материалов, отказ от услуги после оплаты невозможен, возврат средств не производится.'
                    });
                    
                    additionalServicesHTML += '<p><strong>Услуга печати:</strong> ' + data.printing_cost + ' руб. (100% предоплата)</p>';
                }
                
                if (data.include_painting) {
                    additionalStages.push({
                        number: '5',
                        name: 'Покраска',
                        date: data.painting_date,
                        cost: data.painting_cost + ' руб.',
                        condition: '100% предоплата. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от услуги после оплаты невозможен, возврат средств не производится.'
                    });
                    
                    additionalServicesHTML += '<p><strong>Услуга покраски:</strong> ' + data.painting_cost + ' руб. (100% предоплата)</p>';
                }

                // Заполняем оферту
                document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                document.getElementById('purposeDisplay').textContent = data.purpose;
                document.getElementById('fileFormatDisplay').textContent = data.file_format;
                document.getElementById('totalCostDisplay').textContent = data.total_cost;
                document.getElementById('correctionsCostDisplay').textContent = data.corrections_cost;
                document.getElementById('bankDetailsDisplay').textContent = data.bank_details;
                document.getElementById('additionalServicesSection').innerHTML = additionalServicesHTML;

                // Устанавливаем дату договора
                var now = new Date();
                document.getElementById('contractDay').textContent = now.getDate();
                document.getElementById('contractMonth').textContent = getMonthName(now.getMonth());
                document.getElementById('contractYear').textContent = now.getFullYear();

                // Заполняем таблицу основных этапов
                var tableBody = document.getElementById('stagesTableBody');
                tableBody.innerHTML = '';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    var row = '<tr><td>' + stage.number + '</td><td>' + stage.name + '</td><td>' + stage.date + '</td><td>' + stage.cost + '</td><td>' + stage.condition + '</td></tr>';
                    tableBody.innerHTML += row;
                }

                // Заполняем таблицу дополнительных этапов
                var additionalTable = document.getElementById('additionalStagesTable');
                additionalTable.innerHTML = '';
                
                if (additionalStages.length > 0) {
                    var additionalHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><tbody>';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        additionalHTML += '<tr><td>' + additionalStage.number + '</td><td>' + additionalStage.name + '</td><td>' + additionalStage.date + '</td><td>' + additionalStage.cost + '</td><td>' + additionalStage.condition + '</td></tr>';
                    }
                    additionalHTML += '</tbody></table>';
                    additionalTable.innerHTML = additionalHTML;
                }

                // Генерируем уникальную ссылку
                var encodedData = encodeData(data);
                var currentUrl = window.location.href.split('?')[0]; // Берем базовый URL без параметров
                var offerLink = currentUrl + '?offer=' + encodedData;
                
                // Показываем ссылку
                document.getElementById('offerLink').textContent = offerLink;
                
                // Показываем информацию о сроке действия
                var expiryDate = new Date(data.created_at);
                expiryDate.setDate(expiryDate.getDate() + 30);
                document.getElementById('expiryInfo').textContent = 'Ссылка действительна до: ' + formatDate(expiryDate);

                // Сохраняем данные
                window.currentOfferData = data;
                window.currentStages = stages;
                window.additionalStages = additionalStages;
                window.currentOfferLink = offerLink;

                // Показываем результат
                showOffer();
                showMessage('ТЗ-оферта успешно создана!');
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        // Функция для копирования ссылки
        function copyOfferLink() {
            if (window.currentOfferLink) {
                navigator.clipboard.writeText(window.currentOfferLink).then(function() {
                    showMessage('Ссылка скопирована в буфер обмена!');
                }).catch(function() {
                    showTextForCopy(window.currentOfferLink);
                });
            }
        }

        // Функция для загрузки оферты из URL параметров
        function loadOfferFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var offerParam = urlParams.get('offer');
            
            if (offerParam) {
                try {
                    var data = decodeData(offerParam);
                    
                    // Проверяем срок действия
                    if (isLinkExpired(data.created_at)) {
                        showMessage('Ссылка устарела! Создайте новую ТЗ-оферту.', true);
                        return;
                    }
                    
                    // Заполняем оферту данными из URL
                    document.getElementById('projectNumber').textContent = 'Техническое задание № ' + data.project_number;
                    document.getElementById('projectNameDisplay').textContent = 'Проект: ' + data.project_name;
                    document.getElementById('purposeDisplay').textContent = data.purpose;
                    document.getElementById('fileFormatDisplay').textContent = data.file_format;
                    document.getElementById('totalCostDisplay').textContent = data.total_cost;
                    document.getElementById('correctionsCostDisplay').textContent = data.corrections_cost;
                    document.getElementById('bankDetailsDisplay').textContent = data.bank_details;

                    // Рассчитываем этапы
                    var stages = [
                        {
                            number: '1',
                            name: 'Утверждение ТЗ',
                            date: data.stage1_date,
                            cost: Math.round(data.total_cost * 0.2) + ' руб. (20%)',
                            condition: 'Внесение предоплаты.'
                        },
                        {
                            number: '2',
                            name: 'Утверждение 3D-эскиза',
                            date: data.stage2_date,
                            cost: Math.round(data.total_cost * 0.3) + ' руб. (30%)',
                            condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки результатов этапа, работа считается принятой. Очередной платеж подлежит уплате в течение 48 часов с момента принятия этапа.'
                        },
                        {
                            number: '3',
                            name: 'Передача файла ' + data.file_format,
                            date: data.stage3_date,
                            cost: Math.round(data.total_cost * 0.5) + ' руб. (50%)',
                            condition: 'При отсутствии обоснованных замечаний по критериям, указанным в ТЗ, в течение 48 часов с момента отправки финальных скриншотов, работа считается принятой, Заказчик обязан произвести итоговый платеж (если применимо) в течение 48 часов.'
                        }
                    ];

                    // Заполняем таблицу основных этапов
                    var tableBody = document.getElementById('stagesTableBody');
                    tableBody.innerHTML = '';
                    for (var i = 0; i < stages.length; i++) {
                        var stage = stages[i];
                        var row = '<tr><td>' + stage.number + '</td><td>' + stage.name + '</td><td>' + stage.date + '</td><td>' + stage.cost + '</td><td>' + stage.condition + '</td></tr>';
                        tableBody.innerHTML += row;
                    }

                    // Дополнительные этапы
                    var additionalTable = document.getElementById('additionalStagesTable');
                    additionalTable.innerHTML = '';
                    var additionalServicesHTML = '';
                    
                    if (data.include_printing) {
                        var printingHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><tbody>';
                        printingHTML += '<tr><td>4</td><td>Печать</td><td>' + data.printing_date + '</td><td>' + data.printing_cost + ' руб.</td><td>100% предоплата. В связи с заказом физических материалов, отказ от услуги после оплаты невозможен, возврат средств не производится.</td></tr>';
                        printingHTML += '</tbody></table>';
                        additionalTable.innerHTML += printingHTML;
                        
                        additionalServicesHTML += '<p><strong>Услуга печати:</strong> ' + data.printing_cost + ' руб. (100% предоплата)</p>';
                    }
                    
                    if (data.include_painting) {
                        var paintingHTML = '<p><strong>Дополнительные услуги:</strong></p><table class="stages-table"><tbody>';
                        paintingHTML += '<tr><td>' + (data.include_printing ? '5' : '4') + '</td><td>Покраска</td><td>' + data.painting_date + '</td><td>' + data.painting_cost + ' руб.</td><td>100% предоплата. В связи с заказом физических материалов и привлечением сторонних исполнителей, отказ от услуги после оплаты невозможен, возврат средств не производится.</td></tr>';
                        paintingHTML += '</tbody></table>';
                        additionalTable.innerHTML += paintingHTML;
                        
                        additionalServicesHTML += '<p><strong>Услуга покраски:</strong> ' + data.painting_cost + ' руб. (100% предоплата)</p>';
                    }
                    
                    document.getElementById('additionalServicesSection').innerHTML = additionalServicesHTML;

                    // Устанавливаем дату договора
                    var createdDate = new Date(data.created_at);
                    document.getElementById('contractDay').textContent = createdDate.getDate();
                    document.getElementById('contractMonth').textContent = getMonthName(createdDate.getMonth());
                    document.getElementById('contractYear').textContent = createdDate.getFullYear();

                    // Скрываем секцию с ссылкой при просмотре по ссылке
                    document.querySelector('.link-section').style.display = 'none';
                    
                    // Показываем оферту
                    showOffer();
                    
                } catch (error) {
                    console.error('Ошибка загрузки оферты:', error);
                    showMessage('Не удалось загрузить оферту по ссылке', true);
                }
            }
        }

        function showOffer() {
            document.getElementById('formView').style.display = 'none';
            document.getElementById('offerView').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showForm() {
            document.getElementById('offerView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';
            window.scrollTo(0, 0);
            
            // Очищаем параметры URL
            if (window.history.replaceState) {
                var newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        function showMessage(text, isError) {
            var messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.style.display = 'block';
            
            if (isError) {
                messageEl.className = 'message error';
            } else {
                messageEl.className = 'message';
            }
            
            setTimeout(function() {
                messageEl.style.display = 'none';
            }, 4000);
        }

        function shareAsText() {
            try {
                var data = window.currentOfferData;
                var stages = window.currentStages;
                var additionalStages = window.additionalStages;
                
                var text = 'ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ТЗ)\n';
                text += 'к Договору на создание 3D-модели\n\n';
                
                text += 'Техническое задание № ' + data.project_number + '\n';
                text += 'Проект: ' + data.project_name + '\n\n';
                
                text += '1. Цель и назначение модели\n';
                text += data.purpose + '\n\n';
                
                text += '2. Исходные данные\n';
                text += '- Референсные материалы (фотографии, эскизы), предоставленные Заказчиком.\n';
                text += '- Дополнительные пожелания и комментарии Заказчиком, указанные в ходе обсуждения.\n\n';
                
                text += '3. Технические требования к модели\n';
                text += '- Итоговый файл предоставляется в формате ' + data.file_format + ', готовом к 3D-печати.\n';
                text += '- Модель оптимизирована для процесса FDM/SLA печати.\n';
                text += '- Создание 3D-модели по фото является адаптацией и интерпретацией 2D-изображения в трехмерное пространство.\n\n';
                
                text += '4. Визуальные критерии (Критерии оценки)\n';
                text += 'Результат считается соответствующим ТЗ при совпадении по объективным параметрам.\n';
                text += '- Силуэт: узнаваем и сопоставим с исходным изображением\n';
                text += '- Крупные детали: соответствуют референсу\n';
                text += '- Поза: соответствует референсу\n';
                text += '- Композиция: соответствует референсу\n';
                text += '- Мелкая детализация: на усмотрение Исполнителя\n\n';
                
                text += '5. Порядок приемки работы\n';
                text += '- Результаты каждого этапа направляются Заказчику\n';
                text += '- Обратная связь в виде скриншотов с графическими пометками\n';
                text += '- Текстовые описания без пометок не принимаются\n\n';
                
                text += 'ДОГОВОР-ОФЕРТА на оказание услуг по созданию 3D-модели\n\n';
                
                text += 'г. Москва «' + new Date().getDate() + '» ' + getMonthName(new Date().getMonth()) + ' ' + new Date().getFullYear() + ' г.\n\n';
                
                text += '1. ПРЕДМЕТ ДОГОВОРА И ЭТАПЫ РАБОТЫ\n';
                text += 'Исполнитель: Константин Сергеевич С. предлагает заключить настоящий Договор.\n';
                text += 'Акцепт оферты осуществляется путем 100% предоплаты в течение 3 рабочих дней.\n\n';
                
                text += '2. СТОИМОСТЬ, СРОКИ И ПОРЯДОК РАБОТ\n';
                text += 'Общая стоимость Заказа составляет: ' + data.total_cost + ' рублей.\n\n';
                
                text += 'Этапы работы:\n';
                for (var i = 0; i < stages.length; i++) {
                    var stage = stages[i];
                    text += stage.number + '. ' + stage.name + ' | ' + stage.date + ' | ' + stage.cost + '\n';
                    text += 'Условие: ' + stage.condition + '\n\n';
                }
                
                if (additionalStages.length > 0) {
                    text += 'Дополнительные услуги:\n';
                    for (var j = 0; j < additionalStages.length; j++) {
                        var additionalStage = additionalStages[j];
                        text += additionalStage.number + '. ' + additionalStage.name + ' | ' + additionalStage.date + ' | ' + additionalStage.cost + '\n';
                        text += 'Условие: ' + additionalStage.condition + '\n\n';
                    }
                }
                
                text += 'Правки к принятым этапам оплачиваются дополнительно: ' + data.corrections_cost + ' руб./подход\n\n';
                
                text += '3. ПОРЯДОК ОПЛАТЫ\n';
                text += '1. При стоимости до 10 000 ₽ — 100% предоплата\n';
                text += '2. При стоимости свыше 10 000 ₽ — 50% предоплата, 50% после завершения Этапа 3\n';
                text += '3. Реквизиты для оплаты: ' + data.bank_details + '\n';
                text += '4. Подтверждением оплаты является чек\n\n';
                
                text += '4. ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ\n';
                text += 'Услуги печати и покраски являются отдельными с 100% предоплатой.\n';
                
                if (data.include_printing) {
                    text += 'Услуга печати: ' + data.printing_cost + ' руб. (100% предоплата)\n';
                }
                if (data.include_painting) {
                    text += 'Услуга покраски: ' + data.painting_cost + ' руб. (100% предоплата)\n';
                }
                
                text += '\n5. ЗАКЛЮЧИТЕЛЬНЫЕ ПОЛОЖЕНИЯ\n';
                text += '1. Оплата означает принятие условий оферты и ТЗ\n';
                text += '2. Правки к принятым этапам оплачиваются дополнительно\n';
                text += '3. Споры решаются путем переговоров, а при недостижении согласия — в суде\n\n';
                
                text += 'Исполнитель: Константин Сергеевич С.\n\n';
                
                text += 'Создано: ' + data.created_at_display;

                // Пытаемся скопировать
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showMessage('Текст скопирован в буфер обмена!');
                    }).catch(function() {
                        showTextForCopy(text);
                    });
                } else {
                    showTextForCopy(text);
                }
                
            } catch (error) {
                showMessage('Ошибка: ' + error.message, true);
            }
        }

        function showTextForCopy(text) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showMessage('Текст скопирован в буфер обмена!');
            } catch (err) {
                prompt('Скопируйте этот текст:', text);
            }
            
            document.body.removeChild(textArea);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Пытаемся загрузить оферту из URL параметров
            loadOfferFromURL();
            
            // Если оферта не загружена из URL, показываем форму
            if (document.getElementById('formView').style.display !== 'none') {
                showForm();
            }
        });
    </script>
</body>
</html>